IF OBJECT_ID(N'[__EFMigrationsHistory]') IS NULL
BEGIN
    CREATE TABLE [__EFMigrationsHistory] (
        [MigrationId] nvarchar(150) NOT NULL,
        [ProductVersion] nvarchar(32) NOT NULL,
        CONSTRAINT [PK___EFMigrationsHistory] PRIMARY KEY ([MigrationId])
    );
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20181017033735_InitialCreate')
BEGIN
    CREATE TABLE [Accounts] (
        [Id] int NOT NULL IDENTITY,
        [Name] nvarchar(200) NOT NULL,
        [Address] nvarchar(250) NULL,
        [ContactDetails] nvarchar(250) NULL,
        [CreatedOn] datetime2 NOT NULL,
        CONSTRAINT [PK_Accounts] PRIMARY KEY ([Id])
    );
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20181017033735_InitialCreate')
BEGIN
    CREATE TABLE [Groups] (
        [Id] int NOT NULL IDENTITY,
        [Name] nvarchar(150) NOT NULL,
        CONSTRAINT [PK_Groups] PRIMARY KEY ([Id])
    );
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20181017033735_InitialCreate')
BEGIN
    CREATE TABLE [UserRoles] (
        [Id] int NOT NULL IDENTITY,
        [Name] nvarchar(max) NOT NULL,
        CONSTRAINT [PK_UserRoles] PRIMARY KEY ([Id])
    );
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20181017033735_InitialCreate')
BEGIN
    CREATE TABLE [AccountContacts] (
        [Id] int NOT NULL IDENTITY,
        [FirstName] nvarchar(100) NOT NULL,
        [LastName] nvarchar(100) NOT NULL,
        [Email] nvarchar(max) NOT NULL,
        [ContactDetails] nvarchar(100) NULL,
        [AccountId] int NOT NULL,
        [CreatedOn] datetime2 NOT NULL,
        [Active] bit NOT NULL,
        CONSTRAINT [PK_AccountContacts] PRIMARY KEY ([Id]),
        CONSTRAINT [FK_AccountContacts_Accounts_AccountId] FOREIGN KEY ([AccountId]) REFERENCES [Accounts] ([Id]) ON DELETE CASCADE
    );
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20181017033735_InitialCreate')
BEGIN
    CREATE TABLE [Principals] (
        [Id] int NOT NULL IDENTITY,
        [Name] nvarchar(100) NOT NULL,
        [GroupId] int NULL,
        [Active] bit NOT NULL,
        CONSTRAINT [PK_Principals] PRIMARY KEY ([Id]),
        CONSTRAINT [FK_Principals_Groups_GroupId] FOREIGN KEY ([GroupId]) REFERENCES [Groups] ([Id]) ON DELETE NO ACTION
    );
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20181017033735_InitialCreate')
BEGIN
    CREATE TABLE [Users] (
        [Id] int NOT NULL IDENTITY,
        [ObjectId] nvarchar(max) NOT NULL,
        [FirstName] nvarchar(150) NOT NULL,
        [LastName] nvarchar(150) NOT NULL,
        [Email] nvarchar(max) NOT NULL,
        [RoleId] int NULL,
        [GroupId] int NULL,
        [SupervisorId] int NULL,
        [CreatedOn] datetime2 NOT NULL,
        [Active] bit NOT NULL,
        CONSTRAINT [PK_Users] PRIMARY KEY ([Id]),
        CONSTRAINT [FK_Users_Groups_GroupId] FOREIGN KEY ([GroupId]) REFERENCES [Groups] ([Id]) ON DELETE NO ACTION,
        CONSTRAINT [FK_Users_UserRoles_RoleId] FOREIGN KEY ([RoleId]) REFERENCES [UserRoles] ([Id]) ON DELETE NO ACTION,
        CONSTRAINT [FK_Users_Users_SupervisorId] FOREIGN KEY ([SupervisorId]) REFERENCES [Users] ([Id]) ON DELETE NO ACTION
    );
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20181017033735_InitialCreate')
BEGIN
    CREATE TABLE [Products] (
        [Id] int NOT NULL IDENTITY,
        [PrincipalId] int NOT NULL,
        [Name] nvarchar(100) NOT NULL,
        [Active] bit NOT NULL,
        CONSTRAINT [PK_Products] PRIMARY KEY ([Id]),
        CONSTRAINT [FK_Products_Principals_PrincipalId] FOREIGN KEY ([PrincipalId]) REFERENCES [Principals] ([Id]) ON DELETE CASCADE
    );
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20181017033735_InitialCreate')
BEGIN
    CREATE TABLE [GroupMembers] (
        [Id] int NOT NULL IDENTITY,
        [GroupId] int NOT NULL,
        [UserId] int NOT NULL,
        [Role] nvarchar(150) NOT NULL,
        CONSTRAINT [PK_GroupMembers] PRIMARY KEY ([Id]),
        CONSTRAINT [FK_GroupMembers_Groups_GroupId] FOREIGN KEY ([GroupId]) REFERENCES [Groups] ([Id]) ON DELETE CASCADE,
        CONSTRAINT [FK_GroupMembers_Users_UserId] FOREIGN KEY ([UserId]) REFERENCES [Users] ([Id]) ON DELETE CASCADE
    );
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20181017033735_InitialCreate')
BEGIN
    CREATE TABLE [Tickets] (
        [Id] int NOT NULL IDENTITY,
        [Subject] nvarchar(250) NOT NULL,
        [Body] nvarchar(max) NOT NULL,
        [AccountId] int NOT NULL,
        [RequesterId] int NOT NULL,
        [AssigneeId] int NULL,
        [Status] int NOT NULL,
        [Type] int NOT NULL,
        [Priority] int NOT NULL,
        [CreatedOn] datetime2 NOT NULL,
        CONSTRAINT [PK_Tickets] PRIMARY KEY ([Id]),
        CONSTRAINT [FK_Tickets_Accounts_AccountId] FOREIGN KEY ([AccountId]) REFERENCES [Accounts] ([Id]) ON DELETE NO ACTION,
        CONSTRAINT [FK_Tickets_Users_AssigneeId] FOREIGN KEY ([AssigneeId]) REFERENCES [Users] ([Id]) ON DELETE NO ACTION,
        CONSTRAINT [FK_Tickets_AccountContacts_RequesterId] FOREIGN KEY ([RequesterId]) REFERENCES [AccountContacts] ([Id]) ON DELETE NO ACTION
    );
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20181017033735_InitialCreate')
BEGIN
    CREATE TABLE [TicketHistories] (
        [Id] int NOT NULL IDENTITY,
        [TicketId] int NOT NULL,
        [Body] nvarchar(max) NULL,
        [CreatedById] int NOT NULL,
        [CreatedOn] datetime2 NOT NULL,
        CONSTRAINT [PK_TicketHistories] PRIMARY KEY ([Id]),
        CONSTRAINT [FK_TicketHistories_Users_CreatedById] FOREIGN KEY ([CreatedById]) REFERENCES [Users] ([Id]) ON DELETE NO ACTION,
        CONSTRAINT [FK_TicketHistories_Tickets_TicketId] FOREIGN KEY ([TicketId]) REFERENCES [Tickets] ([Id]) ON DELETE CASCADE
    );
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20181017033735_InitialCreate')
BEGIN
    CREATE TABLE [TicketProcedures] (
        [Id] int NOT NULL IDENTITY,
        [TicketId] int NOT NULL,
        [Body] nvarchar(max) NULL,
        [CreatedById] int NOT NULL,
        [CreatedOn] datetime2 NOT NULL,
        CONSTRAINT [PK_TicketProcedures] PRIMARY KEY ([Id]),
        CONSTRAINT [FK_TicketProcedures_Users_CreatedById] FOREIGN KEY ([CreatedById]) REFERENCES [Users] ([Id]) ON DELETE CASCADE,
        CONSTRAINT [FK_TicketProcedures_Tickets_TicketId] FOREIGN KEY ([TicketId]) REFERENCES [Tickets] ([Id]) ON DELETE CASCADE
    );
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20181017033735_InitialCreate')
BEGIN
    CREATE TABLE [TicketProducts] (
        [Id] int NOT NULL IDENTITY,
        [TicketId] int NOT NULL,
        [ProductId] int NOT NULL,
        CONSTRAINT [PK_TicketProducts] PRIMARY KEY ([Id]),
        CONSTRAINT [FK_TicketProducts_Products_ProductId] FOREIGN KEY ([ProductId]) REFERENCES [Products] ([Id]) ON DELETE CASCADE,
        CONSTRAINT [FK_TicketProducts_Tickets_TicketId] FOREIGN KEY ([TicketId]) REFERENCES [Tickets] ([Id]) ON DELETE CASCADE
    );
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20181017033735_InitialCreate')
BEGIN
    CREATE TABLE [TicketResolutions] (
        [Id] int NOT NULL IDENTITY,
        [TicketId] int NOT NULL,
        [Cause] nvarchar(max) NULL,
        [Solution] nvarchar(max) NULL,
        [CreatedById] int NOT NULL,
        [Closed] bit NOT NULL,
        [CreatedOn] datetime2 NOT NULL,
        CONSTRAINT [PK_TicketResolutions] PRIMARY KEY ([Id]),
        CONSTRAINT [FK_TicketResolutions_Users_CreatedById] FOREIGN KEY ([CreatedById]) REFERENCES [Users] ([Id]) ON DELETE CASCADE,
        CONSTRAINT [FK_TicketResolutions_Tickets_TicketId] FOREIGN KEY ([TicketId]) REFERENCES [Tickets] ([Id]) ON DELETE CASCADE
    );
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20181017033735_InitialCreate')
BEGIN
    CREATE INDEX [IX_AccountContacts_AccountId] ON [AccountContacts] ([AccountId]);
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20181017033735_InitialCreate')
BEGIN
    CREATE INDEX [IX_GroupMembers_GroupId] ON [GroupMembers] ([GroupId]);
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20181017033735_InitialCreate')
BEGIN
    CREATE INDEX [IX_GroupMembers_UserId] ON [GroupMembers] ([UserId]);
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20181017033735_InitialCreate')
BEGIN
    CREATE INDEX [IX_Principals_GroupId] ON [Principals] ([GroupId]);
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20181017033735_InitialCreate')
BEGIN
    CREATE UNIQUE INDEX [IX_Principals_Name] ON [Principals] ([Name]);
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20181017033735_InitialCreate')
BEGIN
    CREATE INDEX [IX_Products_Name] ON [Products] ([Name]);
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20181017033735_InitialCreate')
BEGIN
    CREATE INDEX [IX_Products_PrincipalId] ON [Products] ([PrincipalId]);
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20181017033735_InitialCreate')
BEGIN
    CREATE INDEX [IX_TicketHistories_CreatedById] ON [TicketHistories] ([CreatedById]);
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20181017033735_InitialCreate')
BEGIN
    CREATE INDEX [IX_TicketHistories_TicketId] ON [TicketHistories] ([TicketId]);
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20181017033735_InitialCreate')
BEGIN
    CREATE INDEX [IX_TicketProcedures_CreatedById] ON [TicketProcedures] ([CreatedById]);
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20181017033735_InitialCreate')
BEGIN
    CREATE INDEX [IX_TicketProcedures_TicketId] ON [TicketProcedures] ([TicketId]);
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20181017033735_InitialCreate')
BEGIN
    CREATE INDEX [IX_TicketProducts_ProductId] ON [TicketProducts] ([ProductId]);
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20181017033735_InitialCreate')
BEGIN
    CREATE INDEX [IX_TicketProducts_TicketId] ON [TicketProducts] ([TicketId]);
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20181017033735_InitialCreate')
BEGIN
    CREATE INDEX [IX_TicketResolutions_CreatedById] ON [TicketResolutions] ([CreatedById]);
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20181017033735_InitialCreate')
BEGIN
    CREATE INDEX [IX_TicketResolutions_TicketId] ON [TicketResolutions] ([TicketId]);
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20181017033735_InitialCreate')
BEGIN
    CREATE INDEX [IX_Tickets_AccountId] ON [Tickets] ([AccountId]);
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20181017033735_InitialCreate')
BEGIN
    CREATE INDEX [IX_Tickets_AssigneeId] ON [Tickets] ([AssigneeId]);
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20181017033735_InitialCreate')
BEGIN
    CREATE INDEX [IX_Tickets_RequesterId] ON [Tickets] ([RequesterId]);
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20181017033735_InitialCreate')
BEGIN
    CREATE INDEX [IX_Users_GroupId] ON [Users] ([GroupId]);
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20181017033735_InitialCreate')
BEGIN
    CREATE INDEX [IX_Users_RoleId] ON [Users] ([RoleId]);
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20181017033735_InitialCreate')
BEGIN
    CREATE INDEX [IX_Users_SupervisorId] ON [Users] ([SupervisorId]);
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20181017033735_InitialCreate')
BEGIN
    INSERT INTO [__EFMigrationsHistory] ([MigrationId], [ProductVersion])
    VALUES (N'20181017033735_InitialCreate', N'2.1.4-rtm-31024');
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20181018025959_UpdateAccountEntity')
BEGIN
    ALTER TABLE [Accounts] ADD [AccountIndustryId] int NOT NULL DEFAULT 0;
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20181018025959_UpdateAccountEntity')
BEGIN
    ALTER TABLE [Accounts] ADD [Code] nvarchar(max) NULL;
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20181018025959_UpdateAccountEntity')
BEGIN
    ALTER TABLE [Accounts] ADD [TermsOfPayment] int NOT NULL DEFAULT 0;
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20181018025959_UpdateAccountEntity')
BEGIN
    ALTER TABLE [AccountContacts] ADD [Designation] nvarchar(max) NULL;
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20181018025959_UpdateAccountEntity')
BEGIN
    ALTER TABLE [AccountContacts] ADD [PrimaryContact] bit NOT NULL DEFAULT 0;
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20181018025959_UpdateAccountEntity')
BEGIN
    CREATE TABLE [AccountIndustries] (
        [Id] int NOT NULL IDENTITY,
        [Name] nvarchar(max) NOT NULL,
        CONSTRAINT [PK_AccountIndustries] PRIMARY KEY ([Id])
    );
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20181018025959_UpdateAccountEntity')
BEGIN
    CREATE INDEX [IX_Accounts_AccountIndustryId] ON [Accounts] ([AccountIndustryId]);
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20181018025959_UpdateAccountEntity')
BEGIN
    ALTER TABLE [Accounts] ADD CONSTRAINT [FK_Accounts_AccountIndustries_AccountIndustryId] FOREIGN KEY ([AccountIndustryId]) REFERENCES [AccountIndustries] ([Id]) ON DELETE CASCADE;
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20181018025959_UpdateAccountEntity')
BEGIN
    INSERT INTO [__EFMigrationsHistory] ([MigrationId], [ProductVersion])
    VALUES (N'20181018025959_UpdateAccountEntity', N'2.1.4-rtm-31024');
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20181018063510_UpdateAccount')
BEGIN
    DECLARE @var0 sysname;
    SELECT @var0 = [d].[name]
    FROM [sys].[default_constraints] [d]
    INNER JOIN [sys].[columns] [c] ON [d].[parent_column_id] = [c].[column_id] AND [d].[parent_object_id] = [c].[object_id]
    WHERE ([d].[parent_object_id] = OBJECT_ID(N'[Accounts]') AND [c].[name] = N'ContactDetails');
    IF @var0 IS NOT NULL EXEC(N'ALTER TABLE [Accounts] DROP CONSTRAINT [' + @var0 + '];');
    ALTER TABLE [Accounts] ALTER COLUMN [ContactDetails] nvarchar(max) NULL;
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20181018063510_UpdateAccount')
BEGIN
    DECLARE @var1 sysname;
    SELECT @var1 = [d].[name]
    FROM [sys].[default_constraints] [d]
    INNER JOIN [sys].[columns] [c] ON [d].[parent_column_id] = [c].[column_id] AND [d].[parent_object_id] = [c].[object_id]
    WHERE ([d].[parent_object_id] = OBJECT_ID(N'[Accounts]') AND [c].[name] = N'Address');
    IF @var1 IS NOT NULL EXEC(N'ALTER TABLE [Accounts] DROP CONSTRAINT [' + @var1 + '];');
    ALTER TABLE [Accounts] ALTER COLUMN [Address] nvarchar(max) NULL;
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20181018063510_UpdateAccount')
BEGIN
    INSERT INTO [__EFMigrationsHistory] ([MigrationId], [ProductVersion])
    VALUES (N'20181018063510_UpdateAccount', N'2.1.4-rtm-31024');
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20181029054636_UpdateResolution')
BEGIN
    DROP TABLE [TicketResolutions];
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20181029054636_UpdateResolution')
BEGIN
    ALTER TABLE [Tickets] ADD [ClosedOn] datetime2 NULL;
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20181029054636_UpdateResolution')
BEGIN
    ALTER TABLE [Tickets] ADD [Resolution] nvarchar(max) NULL;
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20181029054636_UpdateResolution')
BEGIN
    ALTER TABLE [Tickets] ADD [RootCause] nvarchar(max) NULL;
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20181029054636_UpdateResolution')
BEGIN
    INSERT INTO [__EFMigrationsHistory] ([MigrationId], [ProductVersion])
    VALUES (N'20181029054636_UpdateResolution', N'2.1.4-rtm-31024');
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20181030034218_UpdateUserMakeObjectIdUnique')
BEGIN
    DECLARE @var2 sysname;
    SELECT @var2 = [d].[name]
    FROM [sys].[default_constraints] [d]
    INNER JOIN [sys].[columns] [c] ON [d].[parent_column_id] = [c].[column_id] AND [d].[parent_object_id] = [c].[object_id]
    WHERE ([d].[parent_object_id] = OBJECT_ID(N'[Users]') AND [c].[name] = N'ObjectId');
    IF @var2 IS NOT NULL EXEC(N'ALTER TABLE [Users] DROP CONSTRAINT [' + @var2 + '];');
    ALTER TABLE [Users] ALTER COLUMN [ObjectId] nvarchar(450) NOT NULL;
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20181030034218_UpdateUserMakeObjectIdUnique')
BEGIN
    CREATE UNIQUE INDEX [IX_Users_ObjectId] ON [Users] ([ObjectId]);
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20181030034218_UpdateUserMakeObjectIdUnique')
BEGIN
    INSERT INTO [__EFMigrationsHistory] ([MigrationId], [ProductVersion])
    VALUES (N'20181030034218_UpdateUserMakeObjectIdUnique', N'2.1.4-rtm-31024');
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20181112013238_RemoveTicketProductTable')
BEGIN
    DROP TABLE [TicketProducts];
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20181112013238_RemoveTicketProductTable')
BEGIN
    ALTER TABLE [Tickets] ADD [Products] nvarchar(max) NULL;
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20181112013238_RemoveTicketProductTable')
BEGIN
    INSERT INTO [__EFMigrationsHistory] ([MigrationId], [ProductVersion])
    VALUES (N'20181112013238_RemoveTicketProductTable', N'2.1.4-rtm-31024');
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20181206064029_UpdateGroupTable')
BEGIN
    DROP TABLE [GroupMembers];
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20181206064029_UpdateGroupTable')
BEGIN
    ALTER TABLE [Groups] ADD [Active] bit NOT NULL DEFAULT 0;
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20181206064029_UpdateGroupTable')
BEGIN
    INSERT INTO [__EFMigrationsHistory] ([MigrationId], [ProductVersion])
    VALUES (N'20181206064029_UpdateGroupTable', N'2.1.4-rtm-31024');
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20181211054650_UpdateUserRoles')
BEGIN
    ALTER TABLE [UserRoles] ADD [Actve] bit NOT NULL DEFAULT 0;
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20181211054650_UpdateUserRoles')
BEGIN
    INSERT INTO [__EFMigrationsHistory] ([MigrationId], [ProductVersion])
    VALUES (N'20181211054650_UpdateUserRoles', N'2.1.4-rtm-31024');
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20181212033538_RenameActiveColInUserRole')
BEGIN
    EXEC sp_rename N'[UserRoles].[Actve]', N'Active', N'COLUMN';
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20181212033538_RenameActiveColInUserRole')
BEGIN
    INSERT INTO [__EFMigrationsHistory] ([MigrationId], [ProductVersion])
    VALUES (N'20181212033538_RenameActiveColInUserRole', N'2.1.4-rtm-31024');
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20181212061119_RemoveGroupInUserTbl')
BEGIN
    ALTER TABLE [Users] DROP CONSTRAINT [FK_Users_Groups_GroupId];
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20181212061119_RemoveGroupInUserTbl')
BEGIN
    DROP INDEX [IX_Users_GroupId] ON [Users];
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20181212061119_RemoveGroupInUserTbl')
BEGIN
    DECLARE @var3 sysname;
    SELECT @var3 = [d].[name]
    FROM [sys].[default_constraints] [d]
    INNER JOIN [sys].[columns] [c] ON [d].[parent_column_id] = [c].[column_id] AND [d].[parent_object_id] = [c].[object_id]
    WHERE ([d].[parent_object_id] = OBJECT_ID(N'[Users]') AND [c].[name] = N'GroupId');
    IF @var3 IS NOT NULL EXEC(N'ALTER TABLE [Users] DROP CONSTRAINT [' + @var3 + '];');
    ALTER TABLE [Users] DROP COLUMN [GroupId];
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20181212061119_RemoveGroupInUserTbl')
BEGIN
    INSERT INTO [__EFMigrationsHistory] ([MigrationId], [ProductVersion])
    VALUES (N'20181212061119_RemoveGroupInUserTbl', N'2.1.4-rtm-31024');
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20181217014846_AddProductAssignment')
BEGIN
    CREATE TABLE [ProductAssignments] (
        [Id] int NOT NULL IDENTITY,
        [UserId] int NOT NULL,
        [ProductId] int NOT NULL,
        CONSTRAINT [PK_ProductAssignments] PRIMARY KEY ([Id]),
        CONSTRAINT [FK_ProductAssignments_Products_ProductId] FOREIGN KEY ([ProductId]) REFERENCES [Products] ([Id]) ON DELETE CASCADE,
        CONSTRAINT [FK_ProductAssignments_Users_UserId] FOREIGN KEY ([UserId]) REFERENCES [Users] ([Id]) ON DELETE CASCADE
    );
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20181217014846_AddProductAssignment')
BEGIN
    CREATE INDEX [IX_ProductAssignments_ProductId] ON [ProductAssignments] ([ProductId]);
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20181217014846_AddProductAssignment')
BEGIN
    CREATE INDEX [IX_ProductAssignments_UserId] ON [ProductAssignments] ([UserId]);
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20181217014846_AddProductAssignment')
BEGIN
    INSERT INTO [__EFMigrationsHistory] ([MigrationId], [ProductVersion])
    VALUES (N'20181217014846_AddProductAssignment', N'2.1.4-rtm-31024');
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20190102035120_UpdateTicketForeignKey')
BEGIN
    INSERT INTO [__EFMigrationsHistory] ([MigrationId], [ProductVersion])
    VALUES (N'20190102035120_UpdateTicketForeignKey', N'2.1.4-rtm-31024');
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20190117035621_AddOpportunity')
BEGIN
    CREATE TABLE [Categories] (
        [Id] int NOT NULL IDENTITY,
        [Name] nvarchar(max) NULL,
        [Active] bit NOT NULL,
        CONSTRAINT [PK_Categories] PRIMARY KEY ([Id])
    );
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20190117035621_AddOpportunity')
BEGIN
    CREATE TABLE [Opportunities] (
        [Id] int NOT NULL IDENTITY,
        [AccountId] int NOT NULL,
        [BigDealCode] nvarchar(max) NULL,
        [TotalQty] int NOT NULL,
        [Created] datetime2 NOT NULL,
        [CreatedById] int NOT NULL,
        [Modified] datetime2 NOT NULL,
        [ModifiedById] int NOT NULL,
        [Status] nvarchar(max) NULL,
        CONSTRAINT [PK_Opportunities] PRIMARY KEY ([Id]),
        CONSTRAINT [FK_Opportunities_Accounts_AccountId] FOREIGN KEY ([AccountId]) REFERENCES [Accounts] ([Id]) ON DELETE CASCADE,
        CONSTRAINT [FK_Opportunities_Users_CreatedById] FOREIGN KEY ([CreatedById]) REFERENCES [Users] ([Id]) ON DELETE NO ACTION,
        CONSTRAINT [FK_Opportunities_Users_ModifiedById] FOREIGN KEY ([ModifiedById]) REFERENCES [Users] ([Id]) ON DELETE NO ACTION
    );
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20190117035621_AddOpportunity')
BEGIN
    CREATE TABLE [Stages] (
        [Id] int NOT NULL IDENTITY,
        [Name] nvarchar(max) NULL,
        [Percentage] int NOT NULL,
        [Active] bit NOT NULL,
        CONSTRAINT [PK_Stages] PRIMARY KEY ([Id])
    );
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20190117035621_AddOpportunity')
BEGIN
    CREATE TABLE [ComponentTypes] (
        [Id] int NOT NULL IDENTITY,
        [Name] nvarchar(max) NULL,
        [CategoryId] int NOT NULL,
        [Active] bit NOT NULL,
        CONSTRAINT [PK_ComponentTypes] PRIMARY KEY ([Id]),
        CONSTRAINT [FK_ComponentTypes_Categories_CategoryId] FOREIGN KEY ([CategoryId]) REFERENCES [Categories] ([Id]) ON DELETE NO ACTION
    );
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20190117035621_AddOpportunity')
BEGIN
    CREATE TABLE [Components] (
        [Id] int NOT NULL IDENTITY,
        [OpportunityId] int NOT NULL,
        [Description] nvarchar(max) NULL,
        [CategoryId] int NOT NULL,
        [ComponentTypeId] int NOT NULL,
        [AccountExecutiveId] int NOT NULL,
        [SolutionsArchitectId] int NOT NULL,
        [TargetCloseMonth] datetime2 NOT NULL,
        [StageId] int NOT NULL,
        [ProductId] int NOT NULL,
        [Qty] int NOT NULL,
        [PricePerUnit] decimal(12, 4) NOT NULL,
        [CostPerUnit] decimal(12, 4) NOT NULL,
        [POC] bit NOT NULL,
        [Validity] datetime2 NOT NULL,
        [Status] int NOT NULL,
        [Remarks] nvarchar(max) NULL,
        [Created] datetime2 NOT NULL,
        [CreatedById] int NOT NULL,
        [Modified] datetime2 NOT NULL,
        [ModifiedById] int NOT NULL,
        [VersionNumber] int NOT NULL,
        CONSTRAINT [PK_Components] PRIMARY KEY ([Id]),
        CONSTRAINT [FK_Components_Users_AccountExecutiveId] FOREIGN KEY ([AccountExecutiveId]) REFERENCES [Users] ([Id]) ON DELETE NO ACTION,
        CONSTRAINT [FK_Components_Categories_CategoryId] FOREIGN KEY ([CategoryId]) REFERENCES [Categories] ([Id]) ON DELETE NO ACTION,
        CONSTRAINT [FK_Components_ComponentTypes_ComponentTypeId] FOREIGN KEY ([ComponentTypeId]) REFERENCES [ComponentTypes] ([Id]) ON DELETE NO ACTION,
        CONSTRAINT [FK_Components_Users_CreatedById] FOREIGN KEY ([CreatedById]) REFERENCES [Users] ([Id]) ON DELETE NO ACTION,
        CONSTRAINT [FK_Components_Users_ModifiedById] FOREIGN KEY ([ModifiedById]) REFERENCES [Users] ([Id]) ON DELETE NO ACTION,
        CONSTRAINT [FK_Components_Opportunities_OpportunityId] FOREIGN KEY ([OpportunityId]) REFERENCES [Opportunities] ([Id]) ON DELETE NO ACTION,
        CONSTRAINT [FK_Components_Products_ProductId] FOREIGN KEY ([ProductId]) REFERENCES [Products] ([Id]) ON DELETE NO ACTION,
        CONSTRAINT [FK_Components_Users_SolutionsArchitectId] FOREIGN KEY ([SolutionsArchitectId]) REFERENCES [Users] ([Id]) ON DELETE NO ACTION,
        CONSTRAINT [FK_Components_Stages_StageId] FOREIGN KEY ([StageId]) REFERENCES [Stages] ([Id]) ON DELETE NO ACTION
    );
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20190117035621_AddOpportunity')
BEGIN
    CREATE TABLE [ComponentVersions] (
        [Id] int NOT NULL IDENTITY,
        [ComponentId] int NOT NULL,
        [Added] datetime2 NOT NULL,
        [OpportunityId] int NOT NULL,
        [Description] nvarchar(max) NULL,
        [CategoryId] int NOT NULL,
        [ComponentTypeId] int NOT NULL,
        [AccountExecutiveId] int NOT NULL,
        [SolutionsArchitectId] int NOT NULL,
        [TargetCloseMonth] datetime2 NOT NULL,
        [StageId] int NOT NULL,
        [ProductId] int NOT NULL,
        [Qty] int NOT NULL,
        [PricePerUnit] decimal(12, 4) NOT NULL,
        [CostPerUnit] decimal(12, 4) NOT NULL,
        [POC] bit NOT NULL,
        [Validity] datetime2 NOT NULL,
        [Status] int NOT NULL,
        [Remarks] nvarchar(max) NULL,
        [Created] datetime2 NOT NULL,
        [CreatedById] int NOT NULL,
        [Modified] datetime2 NOT NULL,
        [ModifiedById] int NOT NULL,
        [VersionNumber] int NOT NULL,
        [ComponentId1] int NULL,
        CONSTRAINT [PK_ComponentVersions] PRIMARY KEY ([Id]),
        CONSTRAINT [FK_ComponentVersions_Users_AccountExecutiveId] FOREIGN KEY ([AccountExecutiveId]) REFERENCES [Users] ([Id]) ON DELETE NO ACTION,
        CONSTRAINT [FK_ComponentVersions_Categories_CategoryId] FOREIGN KEY ([CategoryId]) REFERENCES [Categories] ([Id]) ON DELETE NO ACTION,
        CONSTRAINT [FK_ComponentVersions_Components_ComponentId] FOREIGN KEY ([ComponentId]) REFERENCES [Components] ([Id]) ON DELETE CASCADE,
        CONSTRAINT [FK_ComponentVersions_Components_ComponentId1] FOREIGN KEY ([ComponentId1]) REFERENCES [Components] ([Id]) ON DELETE NO ACTION,
        CONSTRAINT [FK_ComponentVersions_ComponentTypes_ComponentTypeId] FOREIGN KEY ([ComponentTypeId]) REFERENCES [ComponentTypes] ([Id]) ON DELETE NO ACTION,
        CONSTRAINT [FK_ComponentVersions_Users_CreatedById] FOREIGN KEY ([CreatedById]) REFERENCES [Users] ([Id]) ON DELETE CASCADE,
        CONSTRAINT [FK_ComponentVersions_Users_ModifiedById] FOREIGN KEY ([ModifiedById]) REFERENCES [Users] ([Id]) ON DELETE NO ACTION,
        CONSTRAINT [FK_ComponentVersions_Opportunities_OpportunityId] FOREIGN KEY ([OpportunityId]) REFERENCES [Opportunities] ([Id]) ON DELETE NO ACTION,
        CONSTRAINT [FK_ComponentVersions_Products_ProductId] FOREIGN KEY ([ProductId]) REFERENCES [Products] ([Id]) ON DELETE NO ACTION,
        CONSTRAINT [FK_ComponentVersions_Users_SolutionsArchitectId] FOREIGN KEY ([SolutionsArchitectId]) REFERENCES [Users] ([Id]) ON DELETE NO ACTION,
        CONSTRAINT [FK_ComponentVersions_Stages_StageId] FOREIGN KEY ([StageId]) REFERENCES [Stages] ([Id]) ON DELETE NO ACTION
    );
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20190117035621_AddOpportunity')
BEGIN
    CREATE UNIQUE INDEX [IX_Components_AccountExecutiveId] ON [Components] ([AccountExecutiveId]);
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20190117035621_AddOpportunity')
BEGIN
    CREATE INDEX [IX_Components_CategoryId] ON [Components] ([CategoryId]);
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20190117035621_AddOpportunity')
BEGIN
    CREATE INDEX [IX_Components_ComponentTypeId] ON [Components] ([ComponentTypeId]);
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20190117035621_AddOpportunity')
BEGIN
    CREATE INDEX [IX_Components_CreatedById] ON [Components] ([CreatedById]);
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20190117035621_AddOpportunity')
BEGIN
    CREATE INDEX [IX_Components_ModifiedById] ON [Components] ([ModifiedById]);
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20190117035621_AddOpportunity')
BEGIN
    CREATE INDEX [IX_Components_OpportunityId] ON [Components] ([OpportunityId]);
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20190117035621_AddOpportunity')
BEGIN
    CREATE INDEX [IX_Components_ProductId] ON [Components] ([ProductId]);
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20190117035621_AddOpportunity')
BEGIN
    CREATE INDEX [IX_Components_SolutionsArchitectId] ON [Components] ([SolutionsArchitectId]);
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20190117035621_AddOpportunity')
BEGIN
    CREATE INDEX [IX_Components_StageId] ON [Components] ([StageId]);
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20190117035621_AddOpportunity')
BEGIN
    CREATE INDEX [IX_ComponentTypes_CategoryId] ON [ComponentTypes] ([CategoryId]);
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20190117035621_AddOpportunity')
BEGIN
    CREATE UNIQUE INDEX [IX_ComponentVersions_AccountExecutiveId] ON [ComponentVersions] ([AccountExecutiveId]);
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20190117035621_AddOpportunity')
BEGIN
    CREATE INDEX [IX_ComponentVersions_CategoryId] ON [ComponentVersions] ([CategoryId]);
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20190117035621_AddOpportunity')
BEGIN
    CREATE INDEX [IX_ComponentVersions_ComponentId] ON [ComponentVersions] ([ComponentId]);
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20190117035621_AddOpportunity')
BEGIN
    CREATE INDEX [IX_ComponentVersions_ComponentId1] ON [ComponentVersions] ([ComponentId1]);
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20190117035621_AddOpportunity')
BEGIN
    CREATE INDEX [IX_ComponentVersions_ComponentTypeId] ON [ComponentVersions] ([ComponentTypeId]);
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20190117035621_AddOpportunity')
BEGIN
    CREATE INDEX [IX_ComponentVersions_CreatedById] ON [ComponentVersions] ([CreatedById]);
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20190117035621_AddOpportunity')
BEGIN
    CREATE INDEX [IX_ComponentVersions_ModifiedById] ON [ComponentVersions] ([ModifiedById]);
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20190117035621_AddOpportunity')
BEGIN
    CREATE INDEX [IX_ComponentVersions_OpportunityId] ON [ComponentVersions] ([OpportunityId]);
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20190117035621_AddOpportunity')
BEGIN
    CREATE INDEX [IX_ComponentVersions_ProductId] ON [ComponentVersions] ([ProductId]);
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20190117035621_AddOpportunity')
BEGIN
    CREATE INDEX [IX_ComponentVersions_SolutionsArchitectId] ON [ComponentVersions] ([SolutionsArchitectId]);
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20190117035621_AddOpportunity')
BEGIN
    CREATE INDEX [IX_ComponentVersions_StageId] ON [ComponentVersions] ([StageId]);
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20190117035621_AddOpportunity')
BEGIN
    CREATE INDEX [IX_Opportunities_AccountId] ON [Opportunities] ([AccountId]);
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20190117035621_AddOpportunity')
BEGIN
    CREATE INDEX [IX_Opportunities_CreatedById] ON [Opportunities] ([CreatedById]);
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20190117035621_AddOpportunity')
BEGIN
    CREATE INDEX [IX_Opportunities_ModifiedById] ON [Opportunities] ([ModifiedById]);
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20190117035621_AddOpportunity')
BEGIN
    INSERT INTO [__EFMigrationsHistory] ([MigrationId], [ProductVersion])
    VALUES (N'20190117035621_AddOpportunity', N'2.1.4-rtm-31024');
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20190122032548_ComponentsInOpportunity')
BEGIN
    ALTER TABLE [Components] ADD [OpportunityId1] int NULL;
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20190122032548_ComponentsInOpportunity')
BEGIN
    CREATE INDEX [IX_Components_OpportunityId1] ON [Components] ([OpportunityId1]);
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20190122032548_ComponentsInOpportunity')
BEGIN
    ALTER TABLE [Components] ADD CONSTRAINT [FK_Components_Opportunities_OpportunityId1] FOREIGN KEY ([OpportunityId1]) REFERENCES [Opportunities] ([Id]) ON DELETE NO ACTION;
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20190122032548_ComponentsInOpportunity')
BEGIN
    INSERT INTO [__EFMigrationsHistory] ([MigrationId], [ProductVersion])
    VALUES (N'20190122032548_ComponentsInOpportunity', N'2.1.4-rtm-31024');
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20190122035140_AddDealSizeInOpportunity')
BEGIN
    ALTER TABLE [Opportunities] ADD [DealSize] decimal(12, 4) NOT NULL DEFAULT 0.0;
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20190122035140_AddDealSizeInOpportunity')
BEGIN
    INSERT INTO [__EFMigrationsHistory] ([MigrationId], [ProductVersion])
    VALUES (N'20190122035140_AddDealSizeInOpportunity', N'2.1.4-rtm-31024');
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20190304052017_SetAccountIndustryOptional')
BEGIN
    ALTER TABLE [Accounts] DROP CONSTRAINT [FK_Accounts_AccountIndustries_AccountIndustryId];
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20190304052017_SetAccountIndustryOptional')
BEGIN
    DECLARE @var4 sysname;
    SELECT @var4 = [d].[name]
    FROM [sys].[default_constraints] [d]
    INNER JOIN [sys].[columns] [c] ON [d].[parent_column_id] = [c].[column_id] AND [d].[parent_object_id] = [c].[object_id]
    WHERE ([d].[parent_object_id] = OBJECT_ID(N'[Components]') AND [c].[name] = N'TargetCloseMonth');
    IF @var4 IS NOT NULL EXEC(N'ALTER TABLE [Components] DROP CONSTRAINT [' + @var4 + '];');
    ALTER TABLE [Components] DROP COLUMN [TargetCloseMonth];
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20190304052017_SetAccountIndustryOptional')
BEGIN
    DECLARE @var5 sysname;
    SELECT @var5 = [d].[name]
    FROM [sys].[default_constraints] [d]
    INNER JOIN [sys].[columns] [c] ON [d].[parent_column_id] = [c].[column_id] AND [d].[parent_object_id] = [c].[object_id]
    WHERE ([d].[parent_object_id] = OBJECT_ID(N'[Components]') AND [c].[name] = N'Validity');
    IF @var5 IS NOT NULL EXEC(N'ALTER TABLE [Components] DROP CONSTRAINT [' + @var5 + '];');
    ALTER TABLE [Components] DROP COLUMN [Validity];
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20190304052017_SetAccountIndustryOptional')
BEGIN
    EXEC sp_rename N'[Components].[POC]', N'Poc', N'COLUMN';
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20190304052017_SetAccountIndustryOptional')
BEGIN
    DECLARE @var6 sysname;
    SELECT @var6 = [d].[name]
    FROM [sys].[default_constraints] [d]
    INNER JOIN [sys].[columns] [c] ON [d].[parent_column_id] = [c].[column_id] AND [d].[parent_object_id] = [c].[object_id]
    WHERE ([d].[parent_object_id] = OBJECT_ID(N'[Opportunities]') AND [c].[name] = N'Status');
    IF @var6 IS NOT NULL EXEC(N'ALTER TABLE [Opportunities] DROP CONSTRAINT [' + @var6 + '];');
    ALTER TABLE [Opportunities] ALTER COLUMN [Status] int NOT NULL;
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20190304052017_SetAccountIndustryOptional')
BEGIN
    ALTER TABLE [Components] ADD [TargetCloseDate] datetime2 NULL;
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20190304052017_SetAccountIndustryOptional')
BEGIN
    ALTER TABLE [Components] ADD [ValidityDate] datetime2 NULL;
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20190304052017_SetAccountIndustryOptional')
BEGIN
    DECLARE @var7 sysname;
    SELECT @var7 = [d].[name]
    FROM [sys].[default_constraints] [d]
    INNER JOIN [sys].[columns] [c] ON [d].[parent_column_id] = [c].[column_id] AND [d].[parent_object_id] = [c].[object_id]
    WHERE ([d].[parent_object_id] = OBJECT_ID(N'[Accounts]') AND [c].[name] = N'AccountIndustryId');
    IF @var7 IS NOT NULL EXEC(N'ALTER TABLE [Accounts] DROP CONSTRAINT [' + @var7 + '];');
    ALTER TABLE [Accounts] ALTER COLUMN [AccountIndustryId] int NULL;
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20190304052017_SetAccountIndustryOptional')
BEGIN
    ALTER TABLE [Accounts] ADD CONSTRAINT [FK_Accounts_AccountIndustries_AccountIndustryId] FOREIGN KEY ([AccountIndustryId]) REFERENCES [AccountIndustries] ([Id]) ON DELETE NO ACTION;
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20190304052017_SetAccountIndustryOptional')
BEGIN
    INSERT INTO [__EFMigrationsHistory] ([MigrationId], [ProductVersion])
    VALUES (N'20190304052017_SetAccountIndustryOptional', N'2.1.4-rtm-31024');
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20190326014113_OpportunityRemoveDealAndQty')
BEGIN
    DECLARE @var8 sysname;
    SELECT @var8 = [d].[name]
    FROM [sys].[default_constraints] [d]
    INNER JOIN [sys].[columns] [c] ON [d].[parent_column_id] = [c].[column_id] AND [d].[parent_object_id] = [c].[object_id]
    WHERE ([d].[parent_object_id] = OBJECT_ID(N'[Opportunities]') AND [c].[name] = N'DealSize');
    IF @var8 IS NOT NULL EXEC(N'ALTER TABLE [Opportunities] DROP CONSTRAINT [' + @var8 + '];');
    ALTER TABLE [Opportunities] DROP COLUMN [DealSize];
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20190326014113_OpportunityRemoveDealAndQty')
BEGIN
    DECLARE @var9 sysname;
    SELECT @var9 = [d].[name]
    FROM [sys].[default_constraints] [d]
    INNER JOIN [sys].[columns] [c] ON [d].[parent_column_id] = [c].[column_id] AND [d].[parent_object_id] = [c].[object_id]
    WHERE ([d].[parent_object_id] = OBJECT_ID(N'[Opportunities]') AND [c].[name] = N'TotalQty');
    IF @var9 IS NOT NULL EXEC(N'ALTER TABLE [Opportunities] DROP CONSTRAINT [' + @var9 + '];');
    ALTER TABLE [Opportunities] DROP COLUMN [TotalQty];
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20190326014113_OpportunityRemoveDealAndQty')
BEGIN
    INSERT INTO [__EFMigrationsHistory] ([MigrationId], [ProductVersion])
    VALUES (N'20190326014113_OpportunityRemoveDealAndQty', N'2.1.4-rtm-31024');
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20190328031628_UpdateComponent')
BEGIN
    DROP INDEX [IX_Components_AccountExecutiveId] ON [Components];
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20190328031628_UpdateComponent')
BEGIN
    DECLARE @var10 sysname;
    SELECT @var10 = [d].[name]
    FROM [sys].[default_constraints] [d]
    INNER JOIN [sys].[columns] [c] ON [d].[parent_column_id] = [c].[column_id] AND [d].[parent_object_id] = [c].[object_id]
    WHERE ([d].[parent_object_id] = OBJECT_ID(N'[Components]') AND [c].[name] = N'ComponentTypeId');
    IF @var10 IS NOT NULL EXEC(N'ALTER TABLE [Components] DROP CONSTRAINT [' + @var10 + '];');
    ALTER TABLE [Components] ALTER COLUMN [ComponentTypeId] int NULL;
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20190328031628_UpdateComponent')
BEGIN
    CREATE INDEX [IX_Components_AccountExecutiveId] ON [Components] ([AccountExecutiveId]);
END;

GO

IF NOT EXISTS(SELECT * FROM [__EFMigrationsHistory] WHERE [MigrationId] = N'20190328031628_UpdateComponent')
BEGIN
    INSERT INTO [__EFMigrationsHistory] ([MigrationId], [ProductVersion])
    VALUES (N'20190328031628_UpdateComponent', N'2.1.4-rtm-31024');
END;

GO

