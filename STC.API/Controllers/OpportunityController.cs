using Microsoft.AspNetCore.Mvc;
using STC.API.Models.Opportunity;
using STC.API.Services;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace STC.API.Controllers
{

    [Route("opportunity")]
    public class OpportunityController : Controller
    {
        private IOpportunityData _opportunityData;
        private IUtils _utils;

        public OpportunityController(IOpportunityData opportunityData, IUtils utils)
        {
            _opportunityData = opportunityData;
            _utils = utils;
        }

        [HttpPost]
        public IActionResult AddOpportunity([FromBody] NewOpportunityDto newOpportunityDto)
        {

            if (ModelState.IsValid)
            {
                if (newOpportunityDto.Components.Count == 0)
                {
                    return BadRequest();
                }
                var newOpportunitySuccess= _opportunityData.AddOpportunity(newOpportunityDto);
                string[] TOs = { _utils.GetApprover() };
                string[] cc = new string[0];
                string subject = "New Opportunity - For Approval";
                FormattableString opportunity = $"<!DOCTYPE html><html xmlns='http://www.w3.org/1999/xhtml' xmlns:v='urn:schemas-microsoft-com:vml' xmlns:o='urn:schemas-microsoft-com:office:office'><head>  <title></title>  <!--[if !mso]><!-- -->  <meta http-equiv='X-UA-Compatible' content='IE=edge'>  <!--<![endif]--><meta http-equiv='Content-Type' content='text/html; charset=UTF-8'><meta name='viewport' content='width=device-width, initial-scale=1.0'><style type='text/css'>  #outlook a {{ padding: 0; }}  .ReadMsgBody {{ width: 100%; }}  .ExternalClass {{ width: 100%; }}  .ExternalClass * {{ line - height:100%; }}  body {{ margin: 0; padding: 0; -webkit-text-size-adjust: 100%; -ms-text-size-adjust: 100%; }}  table, td {{ border - collapse:collapse; mso-table-lspace: 0pt; mso-table-rspace: 0pt; }}  img {{ border: 0; height: auto; line-height: 100%; outline: none; text-decoration: none; -ms-interpolation-mode: bicubic; }}  p {{ display: block; margin: 13px 0; }}</style><!--[if !mso]><!--><style type='text/css'>  @media only screen and (max-width:480px) {{    @-ms-viewport {{ width:320px; }}    @viewport {{ width:320px; }}  }}</style><!--<![endif]--><!--[if mso]><xml>  <o:OfficeDocumentSettings>    <o:AllowPNG/>    <o:PixelsPerInch>96</o:PixelsPerInch>  </o:OfficeDocumentSettings></xml><![endif]--><!--[if lte mso 11]><style type='text/css'>  .outlook-group-fix {{    width:100% !important;  }}</style><![endif]--><!--[if !mso]><!-->    <link href='https://fonts.googleapis.com/css?family=Ubuntu:300,400,500,700' rel='stylesheet' type='text/css'>    <style type='text/css'>        @import url(https://fonts.googleapis.com/css?family=Ubuntu:300,400,500,700);    </style>  <!--<![endif]--><style type='text/css'>  @media only screen and (min-width:480px) {{    .mj - column - per - 100 {{ width:100%!important; }}.mj-column-per-33 {{ width:33.333333%!important; }}  }}</style></head><body style='background: #FFFFFF;'>    <div class='mj-container' style='background-color:#FFFFFF;'><!--[if mso | IE]>      <table role='presentation' border='0' cellpadding='0' cellspacing='0' width='600' align='center' style='width:600px;'>        <tr>          <td style='line-height:0px;font-size:0px;mso-line-height-rule:exactly;'>      <![endif]--><div style='margin:0px auto;max-width:600px;'><table role='presentation' cellpadding='0' cellspacing='0' style='font-size:0px;width:100%;' align='center' border='0'><tbody><tr><td style='text-align:center;vertical-align:top;direction:ltr;font-size:0px;padding:9px 0px 9px 0px;'><!--[if mso | IE]>      <table role='presentation' border='0' cellpadding='0' cellspacing='0'>        <tr>          <td style='vertical-align:top;width:600px;'>      <![endif]--><div class='mj-column-per-100 outlook-group-fix' style='vertical-align:top;display:inline-block;direction:ltr;font-size:13px;text-align:left;width:100%;'><table role='presentation' cellpadding='0' cellspacing='0' style='vertical-align:top;' width='100%' border='0'><tbody><tr><td style='word-wrap:break-word;font-size:0px;padding:0px 0px 0px 0px;' align='left'><div style='cursor:auto;color:#000000;font-family:Ubuntu, Helvetica, Arial, sans-serif;font-size:11px;line-height:1.5;text-align:left;'><h2 style='font-family: &apos;Cabin&apos;, sans-serif; line-height: 100%;'>New Opportunity</h2></div></td></tr></tbody></table></div><!--[if mso | IE]>      </td></tr></table>      <![endif]--></td></tr></tbody></table></div><!--[if mso | IE]>      </td></tr></table>      <![endif]-->      <!--[if mso | IE]>      <table role='presentation' border='0' cellpadding='0' cellspacing='0' width='600' align='center' style='width:600px;'>        <tr>          <td style='line-height:0px;font-size:0px;mso-line-height-rule:exactly;'>      <![endif]--><div style='margin:0px auto;max-width:600px;'><table role='presentation' cellpadding='0' cellspacing='0' style='font-size:0px;width:100%;' align='center' border='0'><tbody><tr><td style='text-align:center;vertical-align:top;direction:ltr;font-size:0px;padding:9px 0px 9px 0px;'><!--[if mso | IE]>      <table role='presentation' border='0' cellpadding='0' cellspacing='0'>        <tr>          <td style='vertical-align:top;width:600px;'>      <![endif]--><div class='mj-column-per-100 outlook-group-fix' style='vertical-align:top;display:inline-block;direction:ltr;font-size:13px;text-align:left;width:100%;'><table role='presentation' cellpadding='0' cellspacing='0' width='100%' border='0'><tbody><tr><td style='word-wrap:break-word;font-size:0px;padding:0px 0px 0px 0px;' align='left'><div style='cursor:auto;color:#000000;font-family:Ubuntu, Helvetica, Arial, sans-serif;font-size:11px;line-height:1.5;text-align:left;'><table border='0' cellpadding='0' cellspacing='0' style='width:100%;'>	<tbody>		<tr>			<td colspan='2'><span style='color:#999999;'><span style='font-size:16px;'>Account </span></span><span style='color:#000000;'><span style='font-size:16px;'>{newOpportunityDto.AccountName}</span></span></td>		</tr>		<tr>			<td colspan='2'><span style='font-size:16px;'><span style='color:#999999;'>Big Deal Code </span><span style='color:#000000;'>{newOpportunityDto.BigDealCode}</span></span></td>		</tr>		<tr>			<td><span style='font-size:16px;'><span style='color:#999999;'>Deal Size </span><span style='color:#000000;'>{newOpportunityDto.DealSize}</span></span></td>			<td><span style='font-size:16px;'><span style='color:#999999;'>Gross Profit </span><span style='color:#000000;'>{newOpportunityDto.GrossProfit}</span></span></td>		</tr>		<tr>			<td colspan='2'><span style='color:#999999;'><span style='font-size:16px;'>Created By </span></span><span style='color:#000000;'><span style='font-size:16px;'>{newOpportunityDto.CreatedByName}</span></span></td>		</tr>	</tbody></table></div></td></tr><tr><td style='word-wrap:break-word;font-size:0px;padding:0px 0px 0px 0px;' align='left'><div style='cursor:auto;color:#000000;font-family:Ubuntu, Helvetica, Arial, sans-serif;font-size:11px;line-height:1.5;text-align:left;'><h2 style='font-family: &apos;Cabin&apos;, sans-serif; line-height: 100%;'>Components</h2></div></td></tr><tr><td style='word-wrap:break-word;font-size:0px;padding:0px 0px 0px 0px;' align='left'><div style='cursor:auto;color:#000000;font-family:Ubuntu, Helvetica, Arial, sans-serif;font-size:11px;line-height:1.5;text-align:left;'>";
                StringBuilder stringBuilder = new StringBuilder();
                stringBuilder.Append(FormattableString.Invariant(opportunity));

                foreach(var component in newOpportunityDto.Components)
                {
                    FormattableString com = $"<table border='0' cellpadding='0' cellspacing='0' style='width:100%;'>	<tbody>		<tr>			<td><span style='font-size:16px;'><span style='color:#999999;'>Category </span><span style='color:#000000;'>{component.CategoryName}</span></span></td>			<td><span style='font-size:16px;'><span style='color:#999999;'>Type </span><span style='color:#000000;'>{component.ComponentTypeName}</span></span></td>		</tr>		<tr>			<td colspan='2'><span style='font-size:16px;'><span style='color:#999999;'>Product </span><span style='color:#000000;'>{component.ProductName}</span></span></td>		</tr>		<tr>			<td><span style='font-size:16px;'><span style='color:#999999;'>Price Per Unit </span><span style='color:#000000;'>{component.PricePerUnit}</span></span></td>			<td><span style='font-size:16px;'><span style='color:#999999;'>Cost Per Unit </span><span style='color:#000000;'>{component.CostPerUnit}</span></span></td>		</tr>		<tr>			<td><span style='font-size:16px;'><span style='color:#999999;'>Quantity </span><span style='color:#000000;'>{component.Qty}</span></span></td>			<td><span style='font-size:16px;'><span style='color:#999999;'>Total Price&#xA0; </span><span style='color:#000000;'>{component.PricePerUnit*component.Qty}</span></span></td>		</tr>		<tr>			<td><span style='font-size:16px;'><span style='color:#999999;'>Stage </span><span style='color:#000000;'>{component.StageName}</span></span></td>			<td><span style='font-size:16px;'><span style='color:#999999;'>POC done? </span><span style='color:#000000;'>{component.Poc}</span></span></td>		</tr>		<tr>			<td><span style='font-size:16px;'><span style='color:#999999;'>Target Close </span><span style='color:#000000;'>{component.TargetCloseDateString}</span></span></td>			<td><span style='font-size:16px;'><span style='color:#999999;'>Validity </span><span style='color:#000000;'>{component.ValidityDateString}</span></span></td>		</tr>		<tr>			<td><span style='font-size:16px;'><span style='color:#999999;'>SA </span><span style='color:#000000;'>{component.SolutionsArchitectName}</span></span></td>			<td><span style='font-size:16px;'><span style='color:#999999;'>AE </span><span style='color:#000000;'>{component.AccountExecutiveName}</span></span></td>		</tr>		<tr>			<td colspan='2'>			<p><span style='font-size:16px;'><span style='color:#999999;'>Description </span><span style='color:#000000;'>{component.Description}</span></span></p>			</td>		</tr>		<tr>			<td colspan='2'>			<p><span style='font-size:16px;'><span style='color:#999999;'>Remarks&#xA0; </span><span style='color:#000000;'>{component.Remarks}</span></span></p>			</td>		</tr>	</tbody></table><p style='font - size:1px; margin: 0px auto; border - top:1px solid #000;width:100%;'></p>";
                    stringBuilder.Append(FormattableString.Invariant(com));
                }

                FormattableString footer = $"</div></td></tr></tbody></table></div><!--[if mso | IE]>      </td></tr></table>      <![endif]--></td></tr></tbody></table></div><!--[if mso | IE]>      </td></tr></table>      <![endif]-->      <!--[if mso | IE]>      <table role='presentation' border='0' cellpadding='0' cellspacing='0' width='600' align='center' style='width:600px;'>        <tr>          <td style='line-height:0px;font-size:0px;mso-line-height-rule:exactly;'>      <![endif]--><div style='margin:0px auto;max-width:600px;'><table role='presentation' cellpadding='0' cellspacing='0' style='font-size:0px;width:100%;' align='center' border='0'><tbody><tr><td style='text-align:center;vertical-align:top;direction:ltr;font-size:0px;padding:9px 0px 9px 0px;'><!--[if mso | IE]>      <table role='presentation' border='0' cellpadding='0' cellspacing='0'>        <tr>          <td style='vertical-align:top;width:198px;'>      <![endif]--><div class='mj-column-per-33 outlook-group-fix' style='vertical-align:top;display:inline-block;direction:ltr;font-size:13px;text-align:left;width:100%;'><table role='presentation' cellpadding='0' cellspacing='0' width='100%' border='0'><tbody><tr><td style='word-wrap:break-word;font-size:0px;padding:20px 20px 20px 20px;' align='center'><table role='presentation' cellpadding='0' cellspacing='0' style='border-collapse:separate;' align='center' border='0'><tbody><tr><td style='border:0px solid #000;border-radius:24px;color:#fff;cursor:auto;padding:9px 26px;' align='center' valign='middle' bgcolor='#013243'><a href='{_utils.GetServer()}/token/{newOpportunitySuccess.Token.Id}' style='text-decoration:none;background:#013243;color:#fff;font-family:Ubuntu, Helvetica, Arial, sans-serif, Helvetica, Arial, sans-serif;font-size:13px;font-weight:normal;line-height:120%;text-transform:none;margin:0px;' target='_blank'>Approve</a></td></tr></tbody></table></td></tr></tbody></table></div><!--[if mso | IE]>      </td><td style='vertical-align:top;width:198px;'>      <![endif]--><div class='mj-column-per-33 outlook-group-fix' style='vertical-align:top;display:inline-block;direction:ltr;font-size:13px;text-align:left;width:100%;'><table role='presentation' cellpadding='0' cellspacing='0' width='100%' border='0'><tbody><tr><td style='word-wrap:break-word;font-size:0px;padding:20px 20px 20px 20px;' align='center'><table role='presentation' cellpadding='0' cellspacing='0' style='border-collapse:separate;' align='center' border='0'><tbody><tr><td style='border:0px solid #000;border-radius:24px;color:#fff;cursor:auto;padding:9px 25px;' align='center' valign='middle' bgcolor='#013243'><a href='{_utils.GetSharePointSite()}?opportunityId={newOpportunitySuccess.Opportunity.Id}' style='text-decoration:none;background:#013243;color:#fff;font-family:Ubuntu, Helvetica, Arial, sans-serif, Helvetica, Arial, sans-serif;font-size:13px;font-weight:normal;line-height:120%;text-transform:none;margin:0px;' target='_blank'>View</a></td></tr></tbody></table></td></tr></tbody></table></div><!--[if mso | IE]>      </td><td style='vertical-align:top;width:198px;'>      <![endif]--><div class='mj-column-per-33 outlook-group-fix' style='vertical-align:top;display:inline-block;direction:ltr;font-size:13px;text-align:left;width:100%;'><table role='presentation' cellpadding='0' cellspacing='0' width='100%' border='0'><tbody><tr><td style='word-wrap:break-word;font-size:0px;padding:20px 20px 20px 20px;' align='center'><table role='presentation' cellpadding='0' cellspacing='0' style='border-collapse:separate;' align='center' border='0'><tbody><tr><td style='border:0px solid #000;border-radius:24px;color:#fff;cursor:auto;padding:9px 25px;' align='center' valign='middle' bgcolor='#013243'><a href='{_utils.GetServer()}/token/reject/{newOpportunitySuccess.Token.Id}' style='text-decoration:none;background:#013243;color:#fff;font-family:Ubuntu, Helvetica, Arial, sans-serif, Helvetica, Arial, sans-serif;font-size:13px;font-weight:normal;line-height:120%;text-transform:none;margin:0px;' target='_blank'>Reject</a></td></tr></tbody></table></td></tr></tbody></table></div><!--[if mso | IE]>      </td></tr></table>      <![endif]--></td></tr></tbody></table></div><!--[if mso | IE]>      </td></tr></table>      <![endif]--></div></body></html>";

                stringBuilder.Append(FormattableString.Invariant(footer));

                _utils.SendPipelineNotif(TOs, cc, subject, stringBuilder.ToString());

                return Ok(newOpportunitySuccess.Opportunity);
            }

            return BadRequest();
        }

        [HttpGet]
        public IActionResult GetOpportunities()
        {
            var opportunities = _opportunityData.GetOpportunities();
            return Ok(opportunities);
        }

        [HttpGet("category")]
        public IActionResult GetCategories()
        {
            return Ok(_opportunityData.GetCategories());
        }

        [HttpGet("componenttype")]
        public IActionResult GetComponentTypes()
        {
            return Ok(_opportunityData.GetComponentTypes());
        }

        [HttpGet("stage")]
        public IActionResult GetStages()
        {
            return Ok(_opportunityData.GetStages());
        }

        [HttpPut("components")]
        public IActionResult EditComponent([FromBody] EditComponentDto editComponentDto)
        {
            if (ModelState.IsValid)
            {
                var updatedComponentSuccess = _opportunityData.UpdateComponent(editComponentDto);
                if (updatedComponentSuccess == null)
                {
                    return NotFound();
                }

                    string[] TOs = { _utils.GetApprover() };
                    string[] cc = new string[0];
                    string subject = "Component Update - For Approval";
                    FormattableString body = $"<!DOCTYPE html><html xmlns='http://www.w3.org/1999/xhtml' xmlns:v='urn:schemas-microsoft-com:vml' xmlns:o='urn:schemas-microsoft-com:office:office'><head>  <title></title>  <!--[if !mso]><!-- -->  <meta http-equiv='X-UA-Compatible' content='IE=edge'>  <!--<![endif]--><meta http-equiv='Content-Type' content='text/html; charset=UTF-8'><meta name='viewport' content='width=device-width, initial-scale=1.0'><style type='text/css'>  #outlook a {{ padding: 0; }}  .ReadMsgBody {{ width: 100%; }}  .ExternalClass {{ width: 100%; }}  .ExternalClass * {{ line-height:100%; }}  body {{ margin: 0; padding: 0; -webkit-text-size-adjust: 100%; -ms-text-size-adjust: 100%; }}  table, td {{ border-collapse:collapse; mso-table-lspace: 0pt; mso-table-rspace: 0pt; }}  img {{ border: 0; height: auto; line-height: 100%; outline: none; text-decoration: none; -ms-interpolation-mode: bicubic; }}  p {{ display: block; margin: 13px 0; }}</style><!--[if !mso]><!--><style type='text/css'>  @media only screen and (max-width:480px) {{    @-ms-viewport {{ width:320px; }}    @viewport {{ width:320px; }}  }}</style><!--<![endif]--><!--[if mso]><xml>  <o:OfficeDocumentSettings>    <o:AllowPNG/>    <o:PixelsPerInch>96</o:PixelsPerInch>  </o:OfficeDocumentSettings></xml><![endif]--><!--[if lte mso 11]><style type='text/css'>  .outlook-group-fix {{    width:100% !important;  }}</style><![endif]--><!--[if !mso]><!-->    <link href='https://fonts.googleapis.com/css?family=Ubuntu:300,400,500,700' rel='stylesheet' type='text/css'>    <style type='text/css'>        @import url(https://fonts.googleapis.com/css?family=Ubuntu:300,400,500,700);    </style>  <!--<![endif]--><style type='text/css'>  @media only screen and (min-width:480px) {{    .mj-column-per-100 {{ width:100%!important; }}.mj-column-per-33 {{ width:33.333333333333336%!important; }}  }}</style></head><body style='background: #FFFFFF;'>    <div class='mj-container' style='background-color:#FFFFFF;'><!--[if mso | IE]>      <table role='presentation' border='0' cellpadding='0' cellspacing='0' width='600' align='center' style='width:600px;'>        <tr>          <td style='line-height:0px;font-size:0px;mso-line-height-rule:exactly;'>      <![endif]--><div style='margin:0px auto;max-width:600px;'><table role='presentation' cellpadding='0' cellspacing='0' style='font-size:0px;width:100%;' align='center' border='0'><tbody><tr><td style='text-align:center;vertical-align:top;direction:ltr;font-size:0px;padding:9px 0px 9px 0px;'><!--[if mso | IE]>      <table role='presentation' border='0' cellpadding='0' cellspacing='0'>        <tr>          <td style='vertical-align:top;width:600px;'>      <![endif]--><div class='mj-column-per-100 outlook-group-fix' style='vertical-align:top;display:inline-block;direction:ltr;font-size:13px;text-align:left;width:100%;'><table role='presentation' cellpadding='0' cellspacing='0' style='vertical-align:top;' width='100%' border='0'><tbody><tr><td style='word-wrap:break-word;font-size:0px;padding:0px 0px 0px 0px;' align='left'><div style='cursor:auto;color:#000000;font-family:Ubuntu, Helvetica, Arial, sans-serif;font-size:11px;line-height:1.5;text-align:left;'><h2 style='font-family: &apos;Cabin&apos;, sans-serif; line-height: 100%;'>Component New Value</h2></div></td></tr></tbody></table></div><!--[if mso | IE]>      </td></tr></table>      <![endif]--></td></tr></tbody></table></div><!--[if mso | IE]>      </td></tr></table>      <![endif]-->      <!--[if mso | IE]>      <table role='presentation' border='0' cellpadding='0' cellspacing='0' width='600' align='center' style='width:600px;'>        <tr>          <td style='line-height:0px;font-size:0px;mso-line-height-rule:exactly;'>      <![endif]--><div style='margin:0px auto;max-width:600px;'><table role='presentation' cellpadding='0' cellspacing='0' style='font-size:0px;width:100%;' align='center' border='0'><tbody><tr><td style='text-align:center;vertical-align:top;direction:ltr;font-size:0px;padding:9px 0px 9px 0px;'><!--[if mso | IE]>      <table role='presentation' border='0' cellpadding='0' cellspacing='0'>        <tr>          <td style='vertical-align:top;width:600px;'>      <![endif]--><div class='mj-column-per-100 outlook-group-fix' style='vertical-align:top;display:inline-block;direction:ltr;font-size:13px;text-align:left;width:100%;'><table role='presentation' cellpadding='0' cellspacing='0' style='vertical-align:top;' width='100%' border='0'><tbody><tr><td style='word-wrap:break-word;font-size:0px;padding:0px 0px 0px 0px;' align='left'><div style='cursor:auto;color:#000000;font-family:Ubuntu, Helvetica, Arial, sans-serif;font-size:11px;line-height:1.5;text-align:left;'><table border='0' cellpadding='0' cellspacing='0' style='width:100%;'>	<tbody>		<tr>			<td colspan='2'><span style='font-size:16px;'><span style='color:#999999;'>Account </span><span style='color:#000000;'>{editComponentDto.AccountName}</span></span></td>		</tr>		<tr>			<td colspan='2'><span style='font-size:16px;'><span style='color:#999999;'>Big Deal Code </span><span style='color:#000000;'>{editComponentDto.BigDealCode}</span></span></td>		</tr>		<tr>			<td colspan='2'><span style='font-size:16px;'><span style='color:#999999;'>Deal Size </span><span style='color:#000000;'>{editComponentDto.DealSize}</span></span></td>		</tr>		<tr>			<td colspan='2'><span style='font-size:16px;'><span style='color:#999999;'>Modified By </span><span style='color:#000000;'>{editComponentDto.ModifiedByName}</span></span></td>		</tr>	</tbody></table><p style='font - size:1px; margin: 0px auto; border - top:1px solid #000;width:100%;'></p></div></td></tr></tbody></table></div><!--[if mso | IE]>      </td></tr></table>      <![endif]--></td></tr></tbody></table></div><!--[if mso | IE]>      </td></tr></table>      <![endif]-->      <!--[if mso | IE]>      <table role='presentation' border='0' cellpadding='0' cellspacing='0' width='600' align='center' style='width:600px;'>        <tr>          <td style='line-height:0px;font-size:0px;mso-line-height-rule:exactly;'>      <![endif]--><div style='margin:0px auto;max-width:600px;'><table role='presentation' cellpadding='0' cellspacing='0' style='font-size:0px;width:100%;' align='center' border='0'><tbody><tr><td style='text-align:center;vertical-align:top;direction:ltr;font-size:0px;padding:9px 0px 9px 0px;'><!--[if mso | IE]>      <table role='presentation' border='0' cellpadding='0' cellspacing='0'>        <tr>          <td style='vertical-align:top;width:600px;'>      <![endif]--><div class='mj-column-per-100 outlook-group-fix' style='vertical-align:top;display:inline-block;direction:ltr;font-size:13px;text-align:left;width:100%;'><table role='presentation' cellpadding='0' cellspacing='0' style='vertical-align:top;' width='100%' border='0'><tbody><tr><td style='word-wrap:break-word;font-size:0px;padding:0px 0px 0px 0px;' align='left'><div style='cursor:auto;color:#000000;font-family:Ubuntu, Helvetica, Arial, sans-serif;font-size:11px;line-height:1.5;text-align:left;'><table border='0' cellpadding='0' cellspacing='0' style='width:100%;'>	<tbody>		<tr>			<td><span style='font-size:16px;'><span style='color:#999999;'>Category </span><span style='color:#000000;'>{editComponentDto.CategoryName}</span></span></td>			<td><span style='font-size:16px;'><span style='color:#999999;'>Type </span>{editComponentDto.ComponentTypeName}</span></td>		</tr>		<tr>			<td colspan='2'><span style='font-size:16px;'><span style='color:#999999;'>Product </span><span style='color:#000000;'>{editComponentDto.ProductName}</span></span></td>		</tr>		<tr>			<td><span style='font-size:16px;'><span style='color:#999999;'>Price Per Unit </span><span style='color:#000000;'>{editComponentDto.PricePerUnit}</span></span></td>			<td><span style='font-size:16px;'><span style='color:#999999;'>Cost Per Unit </span><span style='color:#000000;'>{editComponentDto.CostPerUnit}</span></span></td>		</tr>		<tr>			<td><span style='font-size:16px;'><span style='color:#999999;'>Quantity </span><span style='color:#000000;'>{editComponentDto.Qty}</span></span></td>			<td><span style='font-size:16px;'><span style='color:#999999;'>Total Price&#xA0; </span><span style='color:#000000;'>{editComponentDto.PricePerUnit * editComponentDto.Qty}</span></span></td>		</tr>		<tr>			<td><span style='font-size:16px;'><span style='color:#999999;'>Stage </span><span style='color:#000000;'>{editComponentDto.StageName}</span></span></td>			<td><span style='font-size:16px;'><span style='color:#999999;'>POC done? </span><span style='color:#000000;'>{editComponentDto.Poc}</span></span></td>		</tr>		<tr>			<td><span style='font-size:16px;'><span style='color:#999999;'>Target Close </span><span style='color:#000000;'>{editComponentDto.TargetCloseDateString}</span></span></td>			<td><span style='font-size:16px;'><span style='color:#999999;'>Validity </span><span style='color:#000000;'>{editComponentDto.ValidityDateString}</span></span></td>		</tr>		<tr>			<td><span style='font-size:16px;'><span style='color:#999999;'>SA </span><span style='color:#000000;'>{editComponentDto.SolutionsArchitectName}</span></span></td>			<td><span style='font-size:16px;'><span style='color:#999999;'>AE </span><span style='color:#000000;'>{editComponentDto.AccountExecutiveName}</span></span></td>		</tr>		<tr>			<td colspan='2'>			<p><span style='font-size:16px;'><span style='color:#999999;'>Description </span><span style='color:#000000;'>{editComponentDto.Description}</span></span></p>			</td>		</tr>		<tr>			<td colspan='2'>			<p><span style='font-size:16px;'><span style='color:#999999;'>Remarks&#xA0; </span><span style='color:#000000;'>{editComponentDto.Remarks}</span></span></p>			</td>		</tr>	</tbody></table><p style='font - size:1px; margin: 0px auto; border - top:1px solid #000;width:100%;'></p></div></td></tr></tbody></table></div><!--[if mso | IE]>      </td></tr></table>      <![endif]--></td></tr></tbody></table></div><!--[if mso | IE]>      </td></tr></table>      <![endif]-->      <!--[if mso | IE]>      <table role='presentation' border='0' cellpadding='0' cellspacing='0' width='600' align='center' style='width:600px;'>        <tr>          <td style='line-height:0px;font-size:0px;mso-line-height-rule:exactly;'>      <![endif]--><div style='margin:0px auto;max-width:600px;'><table role='presentation' cellpadding='0' cellspacing='0' style='font-size:0px;width:100%;' align='center' border='0'><tbody><tr><td style='text-align:center;vertical-align:top;direction:ltr;font-size:0px;padding:9px 0px 9px 0px;'><!--[if mso | IE]>      <table role='presentation' border='0' cellpadding='0' cellspacing='0'>        <tr>          <td style='vertical-align:top;width:600px;'>      <![endif]--><div class='mj-column-per-100 outlook-group-fix' style='vertical-align:top;display:inline-block;direction:ltr;font-size:13px;text-align:left;width:100%;'><table role='presentation' cellpadding='0' cellspacing='0' style='vertical-align:top;' width='100%' border='0'><tbody><tr><td style='word-wrap:break-word;font-size:0px;padding:0px 0px 0px 0px;' align='left'><div style='cursor:auto;color:#000000;font-family:Ubuntu, Helvetica, Arial, sans-serif;font-size:11px;line-height:1.5;text-align:left;'><h2 style='font-family: &apos;Cabin&apos;, sans-serif; line-height: 100%;'>Component Old Value</h2></div></td></tr></tbody></table></div><!--[if mso | IE]>      </td></tr></table>      <![endif]--></td></tr></tbody></table></div><!--[if mso | IE]>      </td></tr></table>      <![endif]-->      <!--[if mso | IE]>      <table role='presentation' border='0' cellpadding='0' cellspacing='0' width='600' align='center' style='width:600px;'>        <tr>          <td style='line-height:0px;font-size:0px;mso-line-height-rule:exactly;'>      <![endif]--><div style='margin:0px auto;max-width:600px;'><table role='presentation' cellpadding='0' cellspacing='0' style='font-size:0px;width:100%;' align='center' border='0'><tbody><tr><td style='text-align:center;vertical-align:top;direction:ltr;font-size:0px;padding:9px 0px 9px 0px;'><!--[if mso | IE]>      <table role='presentation' border='0' cellpadding='0' cellspacing='0'>        <tr>          <td style='vertical-align:top;width:600px;'>      <![endif]--><div class='mj-column-per-100 outlook-group-fix' style='vertical-align:top;display:inline-block;direction:ltr;font-size:13px;text-align:left;width:100%;'><table role='presentation' cellpadding='0' cellspacing='0' style='vertical-align:top;' width='100%' border='0'><tbody><tr><td style='word-wrap:break-word;font-size:0px;padding:0px 0px 0px 0px;' align='left'><div style='cursor:auto;color:#000000;font-family:Ubuntu, Helvetica, Arial, sans-serif;font-size:11px;line-height:1.5;text-align:left;'><table border='0' cellpadding='0' cellspacing='0' style='width:100%;'>	<tbody>		<tr>			<td><span style='font-size:16px;'><span style='color:#999999;'>Category </span><span style='color:#000000;'>{editComponentDto.OldComponent.CategoryName}</span></span></td>			<td><span style='font-size:16px;'><span style='color:#999999;'>Type </span>{editComponentDto.OldComponent.ComponentTypeName}</span></td>		</tr>		<tr>			<td colspan='2'><span style='font-size:16px;'><span style='color:#999999;'>Product </span><span style='color:#000000;'>{editComponentDto.OldComponent.ProductName}</span></span></td>		</tr>		<tr>			<td><span style='font-size:16px;'><span style='color:#999999;'>Price Per Unit </span><span style='color:#000000;'>{editComponentDto.OldComponent.PricePerUnit}</span></span></td>			<td><span style='font-size:16px;'><span style='color:#999999;'>Cost Per Unit </span><span style='color:#000000;'>{editComponentDto.OldComponent.CostPerUnit}</span></span></td>		</tr>		<tr>			<td><span style='font-size:16px;'><span style='color:#999999;'>Quantity </span><span style='color:#000000;'>{editComponentDto.OldComponent.Qty}</span></span></td>			<td><span style='font-size:16px;'><span style='color:#999999;'>Total Price&#xA0; </span><span style='color:#000000;'>{editComponentDto.OldComponent.PricePerUnit * editComponentDto.OldComponent.Qty}</span></span></td>		</tr>		<tr>			<td><span style='font-size:16px;'><span style='color:#999999;'>Stage </span><span style='color:#000000;'>{editComponentDto.OldComponent.StageName}</span></span></td>			<td><span style='font-size:16px;'><span style='color:#999999;'>POC done? </span><span style='color:#000000;'>{editComponentDto.OldComponent.Poc}</span></span></td>		</tr>		<tr>			<td><span style='font-size:16px;'><span style='color:#999999;'>Target Close </span><span style='color:#000000;'>{editComponentDto.OldComponent.TargetCloseDateString}</span></span></td>			<td><span style='font-size:16px;'><span style='color:#999999;'>Validity </span><span style='color:#000000;'>{editComponentDto.OldComponent.ValidityDateString}</span></span></td>		</tr>		<tr>			<td><span style='font-size:16px;'><span style='color:#999999;'>SA </span><span style='color:#000000;'>{editComponentDto.OldComponent.SolutionsArchitectName}</span></span></td>			<td><span style='font-size:16px;'><span style='color:#999999;'>AE </span><span style='color:#000000;'>{editComponentDto.OldComponent.AccountExecutiveName}</span></span></td>		</tr>		<tr>			<td colspan='2'>			<p><span style='font-size:16px;'><span style='color:#999999;'>Description </span><span style='color:#000000;'>{editComponentDto.OldComponent.Description}</span></span></p>			</td>		</tr>		<tr>			<td colspan='2'>			<p><span style='font-size:16px;'><span style='color:#999999;'>Remarks&#xA0; </span><span style='color:#000000;'>{editComponentDto.OldComponent.Remarks}</span></span></p>			</td>		</tr>	</tbody></table><p style='font - size:1px; margin: 0px auto; border - top:1px solid #000;width:100%;'></p></div></td></tr></tbody></table></div><!--[if mso | IE]>      </td></tr></table>      <![endif]--></td></tr></tbody></table></div><!--[if mso | IE]>      </td></tr></table>      <![endif]-->      <!--[if mso | IE]>      <table role='presentation' border='0' cellpadding='0' cellspacing='0' width='600' align='center' style='width:600px;'>        <tr>          <td style='line-height:0px;font-size:0px;mso-line-height-rule:exactly;'>      <![endif]--><div style='margin:0px auto;max-width:600px;'><table role='presentation' cellpadding='0' cellspacing='0' style='font-size:0px;width:100%;' align='center' border='0'><tbody><tr><td style='text-align:center;vertical-align:top;direction:ltr;font-size:0px;padding:9px 0px 9px 0px;'><!--[if mso | IE]>      <table role='presentation' border='0' cellpadding='0' cellspacing='0'>        <tr>          <td style='vertical-align:top;width:198px;'>      <![endif]--><div class='mj-column-per-33 outlook-group-fix' style='vertical-align:top;display:inline-block;direction:ltr;font-size:13px;text-align:left;width:100%;'><table role='presentation' cellpadding='0' cellspacing='0' style='vertical-align:top;' width='100%' border='0'><tbody><tr><td style='word-wrap:break-word;font-size:0px;padding:20px 20px 20px 20px;' align='center'><table role='presentation' cellpadding='0' cellspacing='0' style='border-collapse:separate;' align='center' border='0'><tbody><tr><td style='border:0px solid #000;border-radius:24px;color:#fff;cursor:auto;padding:9px 26px;' align='center' valign='middle' bgcolor='#013243'><a href='{_utils.GetServer()}/token/{updatedComponentSuccess.Component.RequestId}' style='text-decoration:none;background:#013243;color:#fff;font-family:Ubuntu, Helvetica, Arial, sans-serif, Helvetica, Arial, sans-serif;font-size:13px;font-weight:normal;line-height:120%;text-transform:none;margin:0px;' target='_blank'>Approve</a></td></tr></tbody></table></td></tr></tbody></table></div><!--[if mso | IE]>      </td><td style='vertical-align:top;width:198px;'>      <![endif]--><div class='mj-column-per-33 outlook-group-fix' style='vertical-align:top;display:inline-block;direction:ltr;font-size:13px;text-align:left;width:100%;'><table role='presentation' cellpadding='0' cellspacing='0' style='vertical-align:top;' width='100%' border='0'><tbody><tr><td style='word-wrap:break-word;font-size:0px;padding:20px 20px 20px 20px;' align='center'><table role='presentation' cellpadding='0' cellspacing='0' style='border-collapse:separate;' align='center' border='0'><tbody><tr><td style='border:0px solid #000;border-radius:24px;color:#fff;cursor:auto;padding:9px 25px;' align='center' valign='middle' bgcolor='#013243'><a href='{_utils.GetSharePointSite()}?opportunityId={editComponentDto.OpportunityId}' style='text-decoration:none;background:#013243;color:#fff;font-family:Ubuntu, Helvetica, Arial, sans-serif, Helvetica, Arial, sans-serif;font-size:13px;font-weight:normal;line-height:120%;text-transform:none;margin:0px;' target='_blank'>View Opportunity</a></td></tr></tbody></table></td></tr></tbody></table></div><!--[if mso | IE]>      </td><td style='vertical-align:top;width:198px;'>      <![endif]--><div class='mj-column-per-33 outlook-group-fix' style='vertical-align:top;display:inline-block;direction:ltr;font-size:13px;text-align:left;width:100%;'><table role='presentation' cellpadding='0' cellspacing='0' style='vertical-align:top;' width='100%' border='0'><tbody><tr><td style='word-wrap:break-word;font-size:0px;padding:20px 20px 20px 20px;' align='center'><table role='presentation' cellpadding='0' cellspacing='0' style='border-collapse:separate;' align='center' border='0'><tbody><tr><td style='border:0px solid #000;border-radius:24px;color:#fff;cursor:auto;padding:9px 25px;' align='center' valign='middle' bgcolor='#013243'><a href='{_utils.GetServer()}/token/reject/{updatedComponentSuccess.Component.RequestId}' style='text-decoration:none;background:#013243;color:#fff;font-family:Ubuntu, Helvetica, Arial, sans-serif, Helvetica, Arial, sans-serif;font-size:13px;font-weight:normal;line-height:120%;text-transform:none;margin:0px;' target='_blank'>Reject</a></td></tr></tbody></table></td></tr></tbody></table></div><!--[if mso | IE]>      </td></tr></table>      <![endif]--></td></tr></tbody></table></div><!--[if mso | IE]>      </td></tr></table>      <![endif]--></div></body></html>";

                    _utils.SendPipelineNotif(TOs, cc, subject, FormattableString.Invariant(body));
                

                return Ok(updatedComponentSuccess);
            }

            return BadRequest();
        }

        [HttpPost("components")]
        public IActionResult AddComponent([FromBody] AddComponentDto addComponentDto)
        {
            if (ModelState.IsValid)
            {
                var opportunity = _opportunityData.GetOpportunity(addComponentDto.OpportunityId);

                if (opportunity == null)
                {
                    return NotFound("Opportunity not found");
                }

                var result = _opportunityData.AddComponent(addComponentDto, opportunity);
                var component = result.Component;
                if (component == null)
                {
                    return StatusCode(500,"Failed to create component");
                }

                string[] TOs = { _utils.GetApprover() };
                string[] cc = new string[0];
                string subject = "New Component - For Approval";
                StringBuilder body = new StringBuilder();

                if (opportunity.Status == Entities.ComponentEntity.Status.ForApproval)
                {
                    FormattableString tmpBody = $"<!DOCTYPE html><html xmlns='http://www.w3.org/1999/xhtml' xmlns:v='urn:schemas-microsoft-com:vml' xmlns:o='urn:schemas-microsoft-com:office:office'><head>  <title></title>  <!--[if !mso]><!-- -->  <meta http-equiv='X-UA-Compatible' content='IE=edge'>  <!--<![endif]--><meta http-equiv='Content-Type' content='text/html; charset=UTF-8'><meta name='viewport' content='width=device-width, initial-scale=1.0'><style type='text/css'>  #outlook a {{ padding: 0; }}  .ReadMsgBody {{ width: 100%; }}  .ExternalClass {{ width: 100%; }}  .ExternalClass * {{ line-height:100%; }}  body {{ margin: 0; padding: 0; -webkit-text-size-adjust: 100%; -ms-text-size-adjust: 100%; }}  table, td {{ border-collapse:collapse; mso-table-lspace: 0pt; mso-table-rspace: 0pt; }}  img {{ border: 0; height: auto; line-height: 100%; outline: none; text-decoration: none; -ms-interpolation-mode: bicubic; }}  p {{ display: block; margin: 13px 0; }}</style><!--[if !mso]><!--><style type='text/css'>  @media only screen and (max-width:480px) {{    @-ms-viewport {{ width:320px; }}    @viewport {{ width:320px; }}  }}</style><!--<![endif]--><!--[if mso]><xml>  <o:OfficeDocumentSettings>    <o:AllowPNG/>    <o:PixelsPerInch>96</o:PixelsPerInch>  </o:OfficeDocumentSettings></xml><![endif]--><!--[if lte mso 11]><style type='text/css'>  .outlook-group-fix {{    width:100% !important;  }}</style><![endif]--><!--[if !mso]><!-->    <link href='https://fonts.googleapis.com/css?family=Ubuntu:300,400,500,700' rel='stylesheet' type='text/css'>    <style type='text/css'>        @import url(https://fonts.googleapis.com/css?family=Ubuntu:300,400,500,700);    </style>  <!--<![endif]--><style type='text/css'>  @media only screen and (min-width:480px) {{    .mj-column-per-100 {{ width:100%!important; }}  }}</style></head><body style='background: #FFFFFF;'>    <div class='mj-container' style='background-color:#FFFFFF;'><!--[if mso | IE]>      <table role='presentation' border='0' cellpadding='0' cellspacing='0' width='600' align='center' style='width:600px;'>        <tr>          <td style='line-height:0px;font-size:0px;mso-line-height-rule:exactly;'>      <![endif]--><div style='margin:0px auto;max-width:600px;'><table role='presentation' cellpadding='0' cellspacing='0' style='font-size:0px;width:100%;' align='center' border='0'><tbody><tr><td style='text-align:center;vertical-align:top;direction:ltr;font-size:0px;padding:9px 0px 9px 0px;'><!--[if mso | IE]>      <table role='presentation' border='0' cellpadding='0' cellspacing='0'>        <tr>          <td style='vertical-align:top;width:600px;'>      <![endif]--><div class='mj-column-per-100 outlook-group-fix' style='vertical-align:top;display:inline-block;direction:ltr;font-size:13px;text-align:left;width:100%;'><table role='presentation' cellpadding='0' cellspacing='0' style='vertical-align:top;' width='100%' border='0'><tbody><tr><td style='word-wrap:break-word;font-size:0px;padding:0px 0px 0px 0px;' align='left'><div style='cursor:auto;color:#000000;font-family:Ubuntu, Helvetica, Arial, sans-serif;font-size:11px;line-height:1.5;text-align:left;'><h2 style='font-family: &apos;Cabin&apos;, sans-serif; line-height: 100%;'>Additional component in new opportunity</h2></div></td></tr><tr><td style='word-wrap:break-word;font-size:0px;padding:0px 0px 0px 0px;' align='left'><div style='cursor:auto;color:#000000;font-family:Ubuntu, Helvetica, Arial, sans-serif;font-size:11px;line-height:1.5;text-align:left;'><table border='0' cellpadding='0' cellspacing='0' style='width:100%;'>	<tbody>		<tr>			<td colspan='2'><span style='font-size:16px;'><span style='color:#999999;'>Account</span><span style='color:#000000;'> {addComponentDto.AccountName}</span></span></td>		</tr>		<tr>			<td colspan='2'><span style='font-size:16px;'><span style='color:#999999;'>Deal Size</span><span style='color:#000000;'> {addComponentDto.DealSize}</span></span></td>		</tr>	</tbody></table></div></td></tr></tbody></table></div><!--[if mso | IE]>      </td></tr></table>      <![endif]--></td></tr></tbody></table></div><!--[if mso | IE]>      </td></tr></table>      <![endif]-->      <!--[if mso | IE]>      <table role='presentation' border='0' cellpadding='0' cellspacing='0' width='600' align='center' style='width:600px;'>        <tr>          <td style='line-height:0px;font-size:0px;mso-line-height-rule:exactly;'>      <![endif]--><div style='margin:0px auto;max-width:600px;'><table role='presentation' cellpadding='0' cellspacing='0' style='font-size:0px;width:100%;' align='center' border='0'><tbody><tr><td style='text-align:center;vertical-align:top;direction:ltr;font-size:0px;padding:9px 0px 9px 0px;'><!--[if mso | IE]>      <table role='presentation' border='0' cellpadding='0' cellspacing='0'>        <tr>          <td style='vertical-align:top;width:600px;'>      <![endif]--><div class='mj-column-per-100 outlook-group-fix' style='vertical-align:top;display:inline-block;direction:ltr;font-size:13px;text-align:left;width:100%;'><table role='presentation' cellpadding='0' cellspacing='0' style='vertical-align:top;' width='100%' border='0'><tbody><tr><td style='word-wrap:break-word;font-size:0px;padding:0px 0px 0px 0px;' align='left'><div style='cursor:auto;color:#000000;font-family:Ubuntu, Helvetica, Arial, sans-serif;font-size:11px;line-height:1.5;text-align:left;'><table border='0' cellpadding='0' cellspacing='0' style='width:100%;'>	<tbody>		<tr>			<td><span style='font-size:16px;'><span style='color:#999999;'>Category </span><span style='color:#000000;'>{addComponentDto.CategoryName}</span></span></td>			<td><span style='font-size:16px;'><span style='color:#999999;'>Type </span><span style='color:#000000;'>{addComponentDto.ComponentTypeName}</span></span></td>		</tr>		<tr>			<td colspan='2'><span style='font-size:16px;'><span style='color:#999999;'>Product </span><span style='color:#000000;'>{addComponentDto.ProductName}</span></span></td>		</tr>		<tr>			<td><span style='font-size:16px;'><span style='color:#999999;'>Price Per Unit </span><span style='color:#000000;'>{addComponentDto.PricePerUnit}</span></span></td>			<td><span style='font-size:16px;'><span style='color:#999999;'>Cost Per Unit </span><span style='color:#000000;'>{addComponentDto.CostPerUnit}</span></span></td>		</tr>		<tr>			<td><span style='font-size:16px;'><span style='color:#999999;'>Quantity </span><span style='color:#000000;'>{addComponentDto.Qty}</span></span></td>			<td><span style='font-size:16px;'><span style='color:#999999;'>Total Price&#xA0; </span><span style='color:#000000;'>{addComponentDto.PricePerUnit * addComponentDto.Qty}</span></span></td>		</tr>		<tr>			<td><span style='font-size:16px;'><span style='color:#999999;'>Stage </span><span style='color:#000000;'>{addComponentDto.StageName}</span></span></td>			<td><span style='font-size:16px;'><span style='color:#999999;'>POC done? </span><span style='color:#000000;'>{addComponentDto.Poc}</span></span></td>		</tr>		<tr>			<td><span style='font-size:16px;'><span style='color:#999999;'>Target Close </span><span style='color:#000000;'>{addComponentDto.TargetCloseDateString}</span></span></td>			<td><span style='font-size:16px;'><span style='color:#999999;'>Validity </span><span style='color:#000000;'>{addComponentDto.ValidityDateString}</span></span></td>		</tr>		<tr>			<td><span style='font-size:16px;'><span style='color:#999999;'>SA </span><span style='color:#000000;'>{addComponentDto.SolutionsArchitectName}</span></span></td>			<td><span style='font-size:16px;'><span style='color:#999999;'>AE </span><span style='color:#000000;'>{addComponentDto.AccountExecutiveName}</span></span></td>		</tr>		<tr>			<td colspan='2'>			<p><span style='font-size:16px;'><span style='color:#999999;'>Description </span><span style='color:#000000;'>{addComponentDto.Description}</span></span></p>			</td>		</tr>		<tr>			<td colspan='2'>			<p><span style='font-size:16px;'><span style='color:#999999;'>Remarks&#xA0; </span><span style='color:#000000;'>{addComponentDto.Remarks}</span></span></p>			</td>		</tr>		<tr>			<td colspan='2'><span style='font-size:16px;'><span style='color:#999999;'>Created By</span><span style='color:#000000;'> {addComponentDto.CreateByName}</span></span></td>		</tr>	</tbody></table></div></td></tr><tr><td style='word-wrap:break-word;font-size:0px;padding:0px 0px 0px 0px;' align='left'><div style='cursor:auto;color:#000000;font-family:Ubuntu, Helvetica, Arial, sans-serif;font-size:11px;line-height:1.5;text-align:left;'><p><span style='font-size:14px;'>The opportunity of this component is still for approval. <a href='{_utils.GetServer()}/token/{opportunity.RequestId}'>Click here</a> to approve the opportunity along with its components.</span></p><p><span style='font-size:14px;'>Please disregard this message if you already rejected the opportunity of this component.</p></div></td></tr><tr><td style='word-wrap:break-word;font-size:0px;padding:0px 0px 0px 0px;' align='center'><table role='presentation' cellpadding='0' cellspacing='0' style='border-collapse:separate;' align='center' border='0'><tbody><tr><td style='border:0px solid #000;border-radius:24px;color:#fff;cursor:auto;padding:9px 26px;' align='center' valign='middle' bgcolor='#e85034'><a href='{_utils.GetSharePointSite()}?opportunityId={addComponentDto.OpportunityId}' style='text-decoration:none;background:#013243;color:#fff;font-family:Ubuntu, Helvetica, Arial, sans-serif, Helvetica, Arial, sans-serif;font-size:13px;font-weight:normal;line-height:120%;text-transform:none;margin:0px;' target='_blank'>View Opportunity</a></td></tr></tbody></table></td></tr></tbody></table></div><!--[if mso | IE]>      </td></tr></table>      <![endif]--></td></tr></tbody></table></div><!--[if mso | IE]>      </td></tr></table>      <![endif]--></div></body></html>";
                    body.Append(FormattableString.Invariant(tmpBody));
                } else
                {
                    FormattableString tmpBody = $"<!DOCTYPE html><html xmlns='http://www.w3.org/1999/xhtml' xmlns:v='urn:schemas-microsoft-com:vml' xmlns:o='urn:schemas-microsoft-com:office:office'><head>  <title></title>  <!--[if !mso]><!-- -->  <meta http-equiv='X-UA-Compatible' content='IE=edge'>  <!--<![endif]--><meta http-equiv='Content-Type' content='text/html; charset=UTF-8'><meta name='viewport' content='width=device-width, initial-scale=1.0'><style type='text/css'>  #outlook a {{ padding: 0; }}  .ReadMsgBody {{ width: 100%; }}  .ExternalClass {{ width: 100%; }}  .ExternalClass * {{ line-height:100%; }}  body {{ margin: 0; padding: 0; -webkit-text-size-adjust: 100%; -ms-text-size-adjust: 100%; }}  table, td {{ border-collapse:collapse; mso-table-lspace: 0pt; mso-table-rspace: 0pt; }}  img {{ border: 0; height: auto; line-height: 100%; outline: none; text-decoration: none; -ms-interpolation-mode: bicubic; }}  p {{ display: block; margin: 13px 0; }}</style><!--[if !mso]><!--><style type='text/css'>  @media only screen and (max-width:480px) {{    @-ms-viewport {{ width:320px; }}    @viewport {{ width:320px; }}  }}</style><!--<![endif]--><!--[if mso]><xml>  <o:OfficeDocumentSettings>    <o:AllowPNG/>    <o:PixelsPerInch>96</o:PixelsPerInch>  </o:OfficeDocumentSettings></xml><![endif]--><!--[if lte mso 11]><style type='text/css'>  .outlook-group-fix {{    width:100% !important;  }}</style><![endif]--><!--[if !mso]><!-->    <link href='https://fonts.googleapis.com/css?family=Ubuntu:300,400,500,700' rel='stylesheet' type='text/css'>    <style type='text/css'>        @import url(https://fonts.googleapis.com/css?family=Ubuntu:300,400,500,700);    </style>  <!--<![endif]--><style type='text/css'>  @media only screen and (min-width:480px) {{    .mj-column-per-100 {{ width:100%!important; }}.mj-column-per-33 {{ width:33.333333%!important; }}  }}</style></head><body style='background: #FFFFFF;'>    <div class='mj-container' style='background-color:#FFFFFF;'><!--[if mso | IE]>      <table role='presentation' border='0' cellpadding='0' cellspacing='0' width='600' align='center' style='width:600px;'>        <tr>          <td style='line-height:0px;font-size:0px;mso-line-height-rule:exactly;'>      <![endif]--><div style='margin:0px auto;max-width:600px;'><table role='presentation' cellpadding='0' cellspacing='0' style='font-size:0px;width:100%;' align='center' border='0'><tbody><tr><td style='text-align:center;vertical-align:top;direction:ltr;font-size:0px;padding:9px 0px 9px 0px;'><!--[if mso | IE]>      <table role='presentation' border='0' cellpadding='0' cellspacing='0'>        <tr>          <td style='vertical-align:top;width:600px;'>      <![endif]--><div class='mj-column-per-100 outlook-group-fix' style='vertical-align:top;display:inline-block;direction:ltr;font-size:13px;text-align:left;width:100%;'><table role='presentation' cellpadding='0' cellspacing='0' style='vertical-align:top;' width='100%' border='0'><tbody><tr><td style='word-wrap:break-word;font-size:0px;padding:0px 0px 0px 0px;' align='left'><div style='cursor:auto;color:#000000;font-family:Ubuntu, Helvetica, Arial, sans-serif;font-size:11px;line-height:1.5;text-align:left;'><h2 style='font-family: &apos;Cabin&apos;, sans-serif; line-height: 100%;'>New Component</h2></div></td></tr></tbody></table></div><!--[if mso | IE]>      </td></tr></table>      <![endif]--></td></tr></tbody></table></div><!--[if mso | IE]>      </td></tr></table>      <![endif]-->      <!--[if mso | IE]>      <table role='presentation' border='0' cellpadding='0' cellspacing='0' width='600' align='center' style='width:600px;'>        <tr>          <td style='line-height:0px;font-size:0px;mso-line-height-rule:exactly;'>      <![endif]--><div style='margin:0px auto;max-width:600px;'><table role='presentation' cellpadding='0' cellspacing='0' style='font-size:0px;width:100%;' align='center' border='0'><tbody><tr><td style='text-align:center;vertical-align:top;direction:ltr;font-size:0px;padding:9px 0px 9px 0px;'><!--[if mso | IE]>      <table role='presentation' border='0' cellpadding='0' cellspacing='0'>        <tr>          <td style='vertical-align:top;width:600px;'>      <![endif]--><div class='mj-column-per-100 outlook-group-fix' style='vertical-align:top;display:inline-block;direction:ltr;font-size:13px;text-align:left;width:100%;'><table role='presentation' cellpadding='0' cellspacing='0' width='100%' border='0'><tbody><tr><td style='word-wrap:break-word;font-size:0px;padding:0px 0px 0px 0px;' align='left'><div style='cursor:auto;color:#000000;font-family:Ubuntu, Helvetica, Arial, sans-serif;font-size:11px;line-height:1.5;text-align:left;'><table border='0' cellpadding='0' cellspacing='0' style='width:100%;'>	<tbody>		<tr>			<td colspan='2'><span style='font-size:16px;'><span style='color:#999999;'>Account</span><span style='color:#000000;'> {addComponentDto.AccountName}</span></span></td>		</tr>		<tr>			<td colspan='2'><span style='font-size:16px;'><span style='color:#999999;'>Deal Size</span><span style='color:#000000;'> {addComponentDto.DealSize}</span></span></td>		</tr>	</tbody></table></div></td></tr></tbody></table></div><!--[if mso | IE]>      </td></tr></table>      <![endif]--></td></tr></tbody></table></div><!--[if mso | IE]>      </td></tr></table>      <![endif]-->      <!--[if mso | IE]>      <table role='presentation' border='0' cellpadding='0' cellspacing='0' width='600' align='center' style='width:600px;'>        <tr>          <td style='line-height:0px;font-size:0px;mso-line-height-rule:exactly;'>      <![endif]--><div style='margin:0px auto;max-width:600px;'><table role='presentation' cellpadding='0' cellspacing='0' style='font-size:0px;width:100%;' align='center' border='0'><tbody><tr><td style='text-align:center;vertical-align:top;direction:ltr;font-size:0px;padding:9px 0px 9px 0px;'><!--[if mso | IE]>      <table role='presentation' border='0' cellpadding='0' cellspacing='0'>        <tr>          <td style='vertical-align:top;width:600px;'>      <![endif]--><div class='mj-column-per-100 outlook-group-fix' style='vertical-align:top;display:inline-block;direction:ltr;font-size:13px;text-align:left;width:100%;'><table role='presentation' cellpadding='0' cellspacing='0' width='100%' border='0'><tbody><tr><td style='word-wrap:break-word;font-size:0px;padding:0px 0px 0px 0px;' align='left'><div style='cursor:auto;color:#000000;font-family:Ubuntu, Helvetica, Arial, sans-serif;font-size:11px;line-height:1.5;text-align:left;'><table border='0' cellpadding='0' cellspacing='0' style='width:100%;'>	<tbody>		<tr>			<td><span style='font-size:16px;'><span style='color:#999999;'>Category </span><span style='color:#000000;'>{addComponentDto.CategoryName}</span></span></td>			<td><span style='font-size:16px;'><span style='color:#999999;'>Type </span><span style='color:#000000;'>{addComponentDto.ComponentTypeName}</span></span></td>		</tr>		<tr>			<td colspan='2'><span style='font-size:16px;'><span style='color:#999999;'>Product </span><span style='color:#000000;'>{addComponentDto.ProductName}</span></span></td>		</tr>		<tr>			<td><span style='font-size:16px;'><span style='color:#999999;'>Price Per Unit </span><span style='color:#000000;'>{addComponentDto.PricePerUnit}</span></span></td>			<td><span style='font-size:16px;'><span style='color:#999999;'>Cost Per Unit </span><span style='color:#000000;'>{addComponentDto.CostPerUnit}</span></span></td>		</tr>		<tr>			<td><span style='font-size:16px;'><span style='color:#999999;'>Quantity </span><span style='color:#000000;'>{addComponentDto.Qty}</span></span></td>			<td><span style='font-size:16px;'><span style='color:#999999;'>Total Price&#xA0; </span><span style='color:#000000;'>{addComponentDto.PricePerUnit * addComponentDto.Qty}</span></span></td>		</tr>		<tr>			<td><span style='font-size:16px;'><span style='color:#999999;'>Stage </span><span style='color:#000000;'>{addComponentDto.StageName}</span></span></td>			<td><span style='font-size:16px;'><span style='color:#999999;'>POC done? </span><span style='color:#000000;'>{addComponentDto.Poc}</span></span></td>		</tr>		<tr>			<td><span style='font-size:16px;'><span style='color:#999999;'>Target Close </span><span style='color:#000000;'>{addComponentDto.TargetCloseDateString}</span></span></td>			<td><span style='font-size:16px;'><span style='color:#999999;'>Validity </span><span style='color:#000000;'>{addComponentDto.ValidityDateString}</span></span></td>		</tr>		<tr>			<td><span style='font-size:16px;'><span style='color:#999999;'>SA </span><span style='color:#000000;'>{addComponentDto.SolutionsArchitectName}</span></span></td>			<td><span style='font-size:16px;'><span style='color:#999999;'>AE </span><span style='color:#000000;'>{addComponentDto.AccountExecutiveName}</span></span></td>		</tr>		<tr>			<td colspan='2'>			<p><span style='font-size:16px;'><span style='color:#999999;'>Description </span><span style='color:#000000;'>{addComponentDto.Description}</span></span></p>			</td>		</tr>		<tr>			<td colspan='2'>			<p><span style='font-size:16px;'><span style='color:#999999;'>Remarks&#xA0; </span><span style='color:#000000;'>{addComponentDto.Remarks}</span></span></p>			</td>		</tr>		<tr>			<td colspan='2'><span style='font-size:16px;'><span style='color:#999999;'>Created By</span><span style='color:#000000;'> {addComponentDto.CreateByName}</span></span></td>		</tr>	</tbody></table></div></td></tr></tbody></table></div><!--[if mso | IE]>      </td></tr></table>      <![endif]--></td></tr></tbody></table></div><!--[if mso | IE]>      </td></tr></table>      <![endif]-->      <!--[if mso | IE]>      <table role='presentation' border='0' cellpadding='0' cellspacing='0' width='600' align='center' style='width:600px;'>        <tr>          <td style='line-height:0px;font-size:0px;mso-line-height-rule:exactly;'>      <![endif]--><div style='margin:0px auto;max-width:600px;'><table role='presentation' cellpadding='0' cellspacing='0' style='font-size:0px;width:100%;' align='center' border='0'><tbody><tr><td style='text-align:center;vertical-align:top;direction:ltr;font-size:0px;padding:0px 0px 0px 0px;'><!--[if mso | IE]>      <table role='presentation' border='0' cellpadding='0' cellspacing='0'>        <tr>          <td style='vertical-align:top;width:198px;'>      <![endif]--><div class='mj-column-per-33 outlook-group-fix' style='vertical-align:top;display:inline-block;direction:ltr;font-size:13px;text-align:left;width:100%;'><table role='presentation' cellpadding='0' cellspacing='0' width='100%' border='0'><tbody><tr><td style='word-wrap:break-word;font-size:0px;padding:20px 20px 20px 20px;' align='center'><table role='presentation' cellpadding='0' cellspacing='0' style='border-collapse:separate;' align='center' border='0'><tbody><tr><td style='border:0px solid #000;border-radius:24px;color:#fff;cursor:auto;padding:9px 26px;' align='center' valign='middle' bgcolor='#013243'><a href='{_utils.GetServer()}/token/{component.RequestId}' style='text-decoration:none;background:#013243;color:#fff;font-family:Ubuntu, Helvetica, Arial, sans-serif, Helvetica, Arial, sans-serif;font-size:13px;font-weight:normal;line-height:120%;text-transform:none;margin:0px;' target='_blank'>Approve</a></td></tr></tbody></table></td></tr></tbody></table></div><!--[if mso | IE]>      </td><td style='vertical-align:top;width:198px;'>      <![endif]--><div class='mj-column-per-33 outlook-group-fix' style='vertical-align:top;display:inline-block;direction:ltr;font-size:13px;text-align:left;width:100%;'><table role='presentation' cellpadding='0' cellspacing='0' width='100%' border='0'><tbody><tr><td style='word-wrap:break-word;font-size:0px;padding:20px 20px 20px 20px;' align='center'><table role='presentation' cellpadding='0' cellspacing='0' style='border-collapse:separate;' align='center' border='0'><tbody><tr><td style='border:0px solid #000;border-radius:24px;color:#fff;cursor:auto;padding:9px 25px;' align='center' valign='middle' bgcolor='#013243'><a href='{_utils.GetSharePointSite()}?opportunityId={addComponentDto.OpportunityId}' style='text-decoration:none;background:#013243;color:#fff;font-family:Ubuntu, Helvetica, Arial, sans-serif, Helvetica, Arial, sans-serif;font-size:13px;font-weight:normal;line-height:120%;text-transform:none;margin:0px;' target='_blank'>View Opportunity</a></td></tr></tbody></table></td></tr></tbody></table></div><!--[if mso | IE]>      </td><td style='vertical-align:top;width:198px;'>      <![endif]--><div class='mj-column-per-33 outlook-group-fix' style='vertical-align:top;display:inline-block;direction:ltr;font-size:13px;text-align:left;width:100%;'><table role='presentation' cellpadding='0' cellspacing='0' width='100%' border='0'><tbody><tr><td style='word-wrap:break-word;font-size:0px;padding:20px 20px 20px 20px;' align='center'><table role='presentation' cellpadding='0' cellspacing='0' style='border-collapse:separate;' align='center' border='0'><tbody><tr><td style='border:0px solid #000;border-radius:24px;color:#fff;cursor:auto;padding:9px 25px;' align='center' valign='middle' bgcolor='#013243'><a href='{_utils.GetServer()}/token/reject/{component.RequestId}' style='text-decoration:none;background:#013243;color:#fff;font-family:Ubuntu, Helvetica, Arial, sans-serif, Helvetica, Arial, sans-serif;font-size:13px;font-weight:normal;line-height:120%;text-transform:none;margin:0px;' target='_blank'>Reject</a></td></tr></tbody></table></td></tr></tbody></table></div><!--[if mso | IE]>      </td></tr></table>      <![endif]--></td></tr></tbody></table></div><!--[if mso | IE]>      </td></tr></table>      <![endif]--></div></body></html>";
                    body.Append(FormattableString.Invariant(tmpBody));
                }


                _utils.SendPipelineNotif(TOs, cc, subject, body.ToString());

                return Ok(result);
            }

            return BadRequest();
        }

        [HttpPut("movecomponents")]
        public IActionResult MoveComponents([FromBody] MoveComponentsDto moveComponentsDto)
        {
            if (ModelState.IsValid)
            {
                var isSuccess = _opportunityData.SaveMoveComponents(moveComponentsDto);
                if (!isSuccess)
                {
                    return NotFound();
                }
                return Ok();
            }
            return BadRequest();
        }
    
        [HttpGet("components/{email}")]
        public IActionResult GetComponentsByEmail(string email)
        {
            var result = _opportunityData.GetComponentsByEmail(email);
            return Ok(result);
        }
    }
}
